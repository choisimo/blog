# =============================================================================
# Nginx Reverse Proxy Configuration - Blog + n8n Workflow Integration
# =============================================================================
# Architecture:
#   Cloudflare Workers → Server:8080 → nginx:80 → Internal Services
#
#   Routes:
#     /api/*        → api:5080              (Backend API)
#     /ai/*         → litellm:4000          (LiteLLM Gateway)
#     /litellm/*    → litellm:4000          (LiteLLM direct)
#     /terminal/*   → terminal-server:8080  (Terminal WebSocket)
#     /webhook/*    → n8n:5678              (n8n Webhooks)
#     /n8n/*        → n8n:5678              (n8n UI - optional)
# =============================================================================

# -----------------------------------------------------------------------------
# Upstream Definitions
# -----------------------------------------------------------------------------
upstream api_upstream {
    server api:5080;
    keepalive 32;
}

upstream n8n_upstream {
    server n8n:5678;
    keepalive 16;
}

# -----------------------------------------------------------------------------
# Main Server
# -----------------------------------------------------------------------------
server {
    listen 80;
    server_name api.nodove.com workflow.nodove.com _;
    
    client_max_body_size 50m;
    
    # Timeouts for long-running requests
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Common proxy headers
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # -------------------------------------------------------------------------
    # Health Check
    # -------------------------------------------------------------------------
    location = / {
        add_header Content-Type text/plain;
        return 200 "nginx ok\n";
    }

    location = /health {
        add_header Content-Type application/json;
        return 200 '{"status":"ok","service":"nginx","integration":"blog-workflow"}';
    }

    # -------------------------------------------------------------------------
    # Backend API (/api/*)
    # -------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://api_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
    }

    # -------------------------------------------------------------------------
    # n8n Webhooks (/webhook/*)
    # -------------------------------------------------------------------------
    # n8n webhook endpoints for workflow triggers
    # Example: POST /webhook/my-workflow-id
    location /webhook/ {
        proxy_pass http://n8n_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
        
        # Longer timeout for workflow execution
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
    }

    # n8n webhook-test for development
    location /webhook-test/ {
        proxy_pass http://n8n_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
    }

    # -------------------------------------------------------------------------
    # n8n UI Access (/n8n/*)
    # -------------------------------------------------------------------------
    # Access n8n UI through main domain (optional - can be disabled in production)
    location /n8n/ {
        rewrite ^/n8n/(.*)$ /$1 break;
        proxy_pass http://n8n_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
        
        # WebSocket support for n8n UI
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
    }

    # -------------------------------------------------------------------------
    # Catch-all: 404
    # -------------------------------------------------------------------------
    location / {
        return 404 '{"error":"Not Found","routes":["/api/*","/webhook/*","/n8n/*"]}';
        add_header Content-Type application/json;
    }
}

# -----------------------------------------------------------------------------
# n8n Dedicated Server (workflow.nodove.com)
# -----------------------------------------------------------------------------
# If you want n8n on a dedicated subdomain
server {
    listen 80;
    server_name workflow.nodove.com;
    
    client_max_body_size 100m;
    
    proxy_connect_timeout 60s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    location / {
        proxy_pass http://n8n_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
        
        # WebSocket support for n8n UI
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
