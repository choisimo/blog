# =============================================================================
# Nginx Reverse Proxy Configuration - Production
# =============================================================================
#
# Architecture: Frontend -> Workers -> Backend
#
#   +------------------+      +---------------------+      +------------------+
#   |    Frontend      | ---> | Cloudflare Workers  | ---> |     Backend      |
#   | (GitHub Pages)   |      |   (Edge Gateway)    |      |  (Self-hosted)   |
#   +------------------+      +---------------------+      +------------------+
#                                      |
#                              X-Backend-Key header
#                              (security validation)
#
# Security:
#   - X-Backend-Key: Workers <-> Backend authentication
#   - Cloudflare IPs only allowed in server firewall
#   - Internal Docker network for service communication
#
# Routes:
#   /api/*        -> api:5080           (Backend API)
#   /ai/*         -> litellm:4000       (LiteLLM AI Gateway)
#   /terminal/*   -> terminal-server    (WebSocket PTY)
#   /webhook/*    -> n8n:5678           (n8n Webhooks)
#
# Environment Variables (set in docker-compose):
#   - NGINX_PORT: Listen port (default: 80)
#   - BACKEND_SECRET_KEY: Shared secret for Workers authentication
#
# =============================================================================

# -----------------------------------------------------------------------------
# Upstream Definitions (Docker internal network)
# -----------------------------------------------------------------------------
upstream api_upstream {
    server api:5080;
    keepalive 32;
}

upstream litellm_upstream {
    server litellm:4000;
    keepalive 16;
}

upstream terminal_upstream {
    server terminal-server:8080;
    keepalive 8;
}

upstream n8n_upstream {
    server n8n:5678;
    keepalive 16;
}

# -----------------------------------------------------------------------------
# Security: Backend Key Validation Map
# -----------------------------------------------------------------------------
# Validates X-Backend-Key header from Workers
# Set BACKEND_SECRET_KEY environment variable
map $http_x_backend_key $backend_key_valid {
    default 0;
    "${BACKEND_SECRET_KEY}" 1;
}

# -----------------------------------------------------------------------------
# Main Server
# -----------------------------------------------------------------------------
server {
    # Port can be overridden via NGINX_PORT env var (default: 80)
    listen 80;
    server_name _;

    client_max_body_size 50m;

    # Timeouts for long-running requests
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Common proxy headers
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # -------------------------------------------------------------------------
    # Health Check (public - no auth required)
    # -------------------------------------------------------------------------
    location = / {
        add_header Content-Type text/plain;
        return 200 "nginx ok\n";
    }

    location = /health {
        add_header Content-Type application/json;
        return 200 '{"status":"ok","service":"nginx-gateway"}';
    }

    # -------------------------------------------------------------------------
    # Backend API (/api/*)
    # -------------------------------------------------------------------------
    # Requires X-Backend-Key header from Workers for authenticated routes
    location /api/ {
        # Validate backend key for write operations (optional - enable if needed)
        # if ($backend_key_valid = 0) {
        #     return 403 '{"error":"Forbidden","message":"Invalid backend key"}';
        # }

        proxy_pass http://api_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;

        # Pass backend key validation status to upstream
        proxy_set_header X-Backend-Key-Valid $backend_key_valid;
    }

    # -------------------------------------------------------------------------
    # LiteLLM Gateway - OpenAI Compatible AI API (/ai/*)
    # -------------------------------------------------------------------------
    location /ai/ {
        rewrite ^/ai/(.*)$ /$1 break;
        proxy_pass http://litellm_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;

        # SSE support for streaming responses
        proxy_cache off;
        chunked_transfer_encoding on;

        # Longer timeout for AI requests
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # LiteLLM Direct Access (/litellm/*)
    location /litellm/ {
        rewrite ^/litellm/(.*)$ /$1 break;
        proxy_pass http://litellm_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # -------------------------------------------------------------------------
    # Terminal Server WebSocket (/terminal/*)
    # -------------------------------------------------------------------------
    location /terminal/ {
        rewrite ^/terminal/(.*)$ /$1 break;
        proxy_pass http://terminal_upstream;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # -------------------------------------------------------------------------
    # n8n Webhooks (/webhook/*)
    # -------------------------------------------------------------------------
    location /webhook/ {
        proxy_pass http://n8n_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;

        # Longer timeout for workflow execution
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
    }

    location /webhook-test/ {
        proxy_pass http://n8n_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
    }

    # -------------------------------------------------------------------------
    # n8n UI Access (/n8n/*) - Optional
    # -------------------------------------------------------------------------
    location /n8n/ {
        rewrite ^/n8n/(.*)$ /$1 break;
        proxy_pass http://n8n_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;

        # WebSocket support for n8n UI
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
    }

    # -------------------------------------------------------------------------
    # Catch-all: 404
    # -------------------------------------------------------------------------
    location / {
        return 404 '{"error":"Not Found","routes":["/api/*","/ai/*","/terminal/*","/webhook/*"]}';
        add_header Content-Type application/json;
    }
}
