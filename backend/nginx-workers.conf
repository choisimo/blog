# =============================================================================
# Nginx Reverse Proxy Configuration - Workers Gateway Mode
# =============================================================================
# Architecture:
#   Cloudflare Workers → Server IP:8080 → Nginx:80 → Services
#
#   ┌──────────────────────┐
#   │ Cloudflare Workers  │
#   │  (API Gateway)     │
#   └──────────┬───────────┘
#              │ HTTPS (Custom Domain)
#              ▼
#   ┌──────────────────────┐
#   │ Server Firewall     │ ← Cloudflare IPs only
#   └──────────┬───────────┘
#              │
#              ▼
#   ┌──────────────────────┐
#   │    Nginx :8080      │ ← Changed from :80
#   └──────────┬───────────┘
#              │ Docker Internal Network
#       ┌──────┼──────┬──────┬──────┐
#       ▼      ▼      ▼      ▼
#     api  litellm  terminal  etc
#
# Routes (Workers → Nginx → Services):
#   /api/*        → api:5080
#   /ai/*         → litellm:4000
#   /litellm/*    → litellm:4000
#   /terminal/*   → terminal-server:8080
#
# Important:
#   - Nginx listens on :8080 (exposed to Workers)
#   - Workers handles HTTPS termination
#   - Cloudflare IPs only allowed in firewall
# =============================================================================

# -----------------------------------------------------------------------------
# Upstream Definitions
# -----------------------------------------------------------------------------
upstream api_upstream {
    server api:5080;
    keepalive 32;
}

upstream litellm_upstream {
    server litellm:4000;
    keepalive 16;
}

upstream terminal_upstream {
    server terminal-server:8080;
    keepalive 8;
}

# -----------------------------------------------------------------------------
# Main Server
# -----------------------------------------------------------------------------
server {
    listen 8080;  # Changed from 80 (Workers connects here)
    server_name _;  # Removed server_name (Workers sets Host header)

    client_max_body_size 10m;

    # Timeouts for long-running AI requests
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Common proxy headers
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # -------------------------------------------------------------------------
    # Health Check (root)
    # -------------------------------------------------------------------------
    location = / {
        add_header Content-Type text/plain;
        return 200 "nginx gateway ok\n";
    }

    location = /health {
        add_header Content-Type application/json;
        return 200 '{"status":"ok","service":"nginx-gateway"}';
    }

    # -------------------------------------------------------------------------
    # Backend API (/api/*)
    # -------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://api_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
    }

    # -------------------------------------------------------------------------
    # LiteLLM Gateway - OpenAI Compatible AI API (/ai/*)
    # -------------------------------------------------------------------------
    location /ai/ {
        rewrite ^/ai/(.*)$ /$1 break;
        proxy_pass http://litellm_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;

        # SSE support for streaming responses
        proxy_cache off;
        chunked_transfer_encoding on;

        # Longer timeout for AI requests
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # -------------------------------------------------------------------------
    # LiteLLM Direct Access (/litellm/*)
    # -------------------------------------------------------------------------
    location /litellm/ {
        rewrite ^/litellm/(.*)$ /$1 break;
        proxy_pass http://litellm_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;

        # SSE support
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # -------------------------------------------------------------------------
    # Terminal Server WebSocket (/terminal/*)
    # -------------------------------------------------------------------------
    location /terminal/ {
        rewrite ^/terminal/(.*)$ /$1 break;
        proxy_pass http://terminal_upstream;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # -------------------------------------------------------------------------
    # Catch-all: 404
    # -------------------------------------------------------------------------
    location / {
        return 404 '{"error":"Not Found","hint":"Use /api/*, /ai/*, /litellm/*, or /terminal/*"}';
        add_header Content-Type application/json;
    }
}
