# =============================================================================
# Nginx Load Balancer for AI Services (3 Replicas)
# =============================================================================
# 
# Architecture:
#   Client Request
#        │
#        ▼
#   ┌─────────────────────────────────────────────────────────────────┐
#   │                    nginx-lb (Load Balancer)                      │
#   │                                                                   │
#   │  Port 7016 (vas-proxy)          Port 7012 (vas-core)            │
#   │        │                               │                         │
#   │        ▼                               ▼                         │
#   │  ┌──────────────┐              ┌──────────────┐                 │
#   │  │  upstream    │              │  upstream    │                 │
#   │  │  vas_proxy   │              │  vas_core    │                 │
#   │  │  (3 nodes)   │              │  (3 nodes)   │                 │
#   │  └──────────────┘              └──────────────┘                 │
#   │        │                               │                         │
#   │   ┌────┼────┐                    ┌────┼────┐                    │
#   │   ▼    ▼    ▼                    ▼    ▼    ▼                    │
#   │  P1   P2   P3                   C1   C2   C3                    │
#   └─────────────────────────────────────────────────────────────────┘
#
# Load Balancing Strategy: least_conn (최소 연결 수 기반)
# - AI 요청은 처리 시간이 불균일하므로 round-robin보다 적합
# - 현재 연결 수가 가장 적은 서버로 요청 분배
#
# Health Check:
# - max_fails=3: 3번 연속 실패 시 서버를 일시적으로 제외
# - fail_timeout=30s: 30초 동안 제외 후 다시 시도
# =============================================================================

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging format with upstream info
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" upstream=$upstream_addr '
                    'response_time=$upstream_response_time';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript;

    # =========================================================================
    # Upstream: VAS Proxy (auto-chat-proxy) - 3 Replicas
    # =========================================================================
    upstream vas_proxy_pool {
        # least_conn: 현재 활성 연결이 가장 적은 서버로 라우팅
        # AI 요청은 처리 시간이 다양하므로 이 방식이 더 효율적
        least_conn;

        server auto-chat-proxy-1:7016 max_fails=3 fail_timeout=30s;
        server auto-chat-proxy-2:7016 max_fails=3 fail_timeout=30s;
        server auto-chat-proxy-3:7016 max_fails=3 fail_timeout=30s;

        keepalive 32;
    }

    # =========================================================================
    # Upstream: VAS Core (opencode) - 3 Replicas
    # =========================================================================
    upstream vas_core_pool {
        least_conn;

        server opencode-1:7012 max_fails=3 fail_timeout=30s;
        server opencode-2:7012 max_fails=3 fail_timeout=30s;
        server opencode-3:7012 max_fails=3 fail_timeout=30s;

        keepalive 32;
    }

    # =========================================================================
    # Server: VAS Proxy Load Balancer (Port 7016)
    # =========================================================================
    server {
        listen 7016;
        server_name _;

        # AI 요청을 위한 긴 타임아웃
        proxy_connect_timeout 60s;
        proxy_send_timeout 180s;
        proxy_read_timeout 180s;

        # 요청 본문 크기 제한 (이미지 분석용)
        client_max_body_size 20m;

        # 공통 프록시 헤더
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Health check endpoint
        location = /health {
            proxy_pass http://vas_proxy_pool/health;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }

        # Status endpoint
        location = /status {
            proxy_pass http://vas_proxy_pool/status;
        }

        # Load balancer status (for monitoring)
        location = /lb-status {
            add_header Content-Type application/json;
            return 200 '{"service":"nginx-lb","status":"ok","upstreams":{"vas_proxy":3,"vas_core":3}}';
        }

        # Auto-chat endpoint (main AI endpoint)
        location /auto-chat {
            proxy_pass http://vas_proxy_pool;
            
            # SSE/스트리밍 지원
            proxy_buffering off;
            proxy_cache off;
            chunked_transfer_encoding on;

            # 긴 AI 응답을 위한 추가 타임아웃
            proxy_read_timeout 300s;
        }

        # 기타 모든 요청
        location / {
            proxy_pass http://vas_proxy_pool;
            proxy_buffering off;
        }
    }

    # =========================================================================
    # Server: VAS Core Load Balancer (Port 7012)
    # =========================================================================
    server {
        listen 7012;
        server_name _;

        proxy_connect_timeout 60s;
        proxy_send_timeout 180s;
        proxy_read_timeout 180s;

        client_max_body_size 20m;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";

        # App endpoint (health check용)
        location = /app {
            proxy_pass http://vas_core_pool/app;
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
        }

        # Config/providers endpoint
        location /config/ {
            proxy_pass http://vas_core_pool;
        }

        # Session management
        location /session {
            proxy_pass http://vas_core_pool;
            proxy_buffering off;
        }

        # 모든 요청
        location / {
            proxy_pass http://vas_core_pool;
            proxy_buffering off;
        }
    }
}
