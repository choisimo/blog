<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proxy Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style> body{padding:20px} pre{white-space:pre-wrap} .mono{font-family:ui-monospace,monospace} </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-3">Proxy Admin</h1>

    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6">
        <label class="form-label">Base URL</label>
        <input id="base" class="form-control" placeholder="http://localhost:7080" />
      </div>
      <div class="col-12 col-md-6">
        <label class="form-label">Admin JWT (Bearer ...)</label>
        <input id="jwt" class="form-control" placeholder="Bearer ..." />
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">Tokens <span class="badge text-bg-info" id="bootstrapBadge" style="display:none">Bootstrap Mode</span></div>
      <div class="card-body">
        <div class="row g-2 align-items-end mb-2">
          <div class="col-12 col-md-4"><input id="tokName" class="form-control" placeholder="name" /></div>
          <div class="col-12 col-md-3"><input id="tokScopes" class="form-control" placeholder="scopes comma" /></div>
          <div class="col-6 col-md-2"><input id="tokTTL" type="number" class="form-control" placeholder="ttl(h)" value="24" /></div>
          <div class="col-6 col-md-3"><button class="btn btn-primary w-100" onclick="createToken()">Create</button></div>
        </div>
        <div class="mb-2"><button class="btn btn-outline-secondary btn-sm" onclick="listTokens()">List</button></div>
        <pre id="tokOut" class="mono"></pre>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Upstreams</div>
      <div class="card-body">
        <div class="row g-2 align-items-end mb-2">
          <div class="col-12 col-md-4"><input id="upId" class="form-control" placeholder="id (optional)" /></div>
          <div class="col-12 col-md-6"><input id="upUrl" class="form-control" placeholder="baseUrl" /></div>
          <div class="col-12 col-md-2"><button class="btn btn-primary w-100" onclick="addUpstream()">Add</button></div>
        </div>
        <div class="mb-2"><button class="btn btn-outline-secondary btn-sm" onclick="listUpstreams()">List</button></div>
        <pre id="upOut" class="mono"></pre>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Proxy Test: /proxy/auto-chat</div>
      <div class="card-body">
        <div class="row g-2 align-items-end mb-2">
          <div class="col-12"><textarea id="body" class="form-control" rows="5">{
  "title": "Auto",
  "message": "hello from admin",
  "providerID": "openai",
  "modelID": "gpt-4.1"
}</textarea></div>
          <div class="col-12 col-md-3"><button class="btn btn-success w-100" onclick="callProxy()">Send</button></div>
        </div>
        <pre id="proxyOut" class="mono"></pre>
      </div>
    </div>
    <div class="card mb-3">
      <div class="card-header">Config</div>
      <div class="card-body">
        <div class="row g-2 align-items-end mb-2">
          <div class="col-12 col-md-4"><label class="form-label">Require Auth</label><select id="cfgAuth" class="form-select"><option value="true">true</option><option value="false">false</option></select></div>
          <div class="col-12 col-md-8"><label class="form-label">Allowed Models (comma)</label><input id="cfgModels" class="form-control" /></div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="loadConfig()">Load</button>
          <button class="btn btn-warning btn-sm" onclick="saveConfig()">Save</button>
        </div>
      </div>
    </div>
  </div>
 
  <script>
    const base = document.getElementById('base');
    const jwt = document.getElementById('jwt');
    base.value = localStorage.getItem('pa_base') || location.origin;
    jwt.value = localStorage.getItem('pa_jwt') || '';
    base.addEventListener('change', ()=> localStorage.setItem('pa_base', base.value.trim()));
    jwt.addEventListener('change', ()=> localStorage.setItem('pa_jwt', jwt.value.trim()));

    function headers() { const h = {'Content-Type':'application/json'}; const v = jwt.value.trim(); if (v) h['Authorization'] = v; return h; }
    async function j(method, path, data) {
      const resp = await fetch(base.value + path, {method, headers: headers(), body: data?JSON.stringify(data):undefined});
      const text = await resp.text(); try { return JSON.parse(text) } catch { return text }
    }

    async function listTokens(){ const out = await j('GET','/admin/token'); document.getElementById('tokOut').textContent = JSON.stringify(out,null,2) }
    async function createToken(){ const name = document.getElementById('tokName').value.trim()||'token'; const scopes = (document.getElementById('tokScopes').value||'').split(',').map(s=>s.trim()).filter(Boolean); const ttl = parseInt(document.getElementById('tokTTL').value||'24',10); const out = await j('POST','/admin/token',{name,scopes,ttlHours:ttl}); document.getElementById('tokOut').textContent = JSON.stringify(out,null,2); if(out && out.bootstrap){ document.getElementById('bootstrapBadge').style.display='inline-block'; } }

    async function listUpstreams(){ const out = await j('GET','/admin/upstream'); document.getElementById('upOut').textContent = JSON.stringify(out,null,2) }
    async function addUpstream(){ const id = document.getElementById('upId').value.trim(); const baseUrl = document.getElementById('upUrl').value.trim(); const out = await j('POST','/admin/upstream',{id,baseUrl}); document.getElementById('upOut').textContent = JSON.stringify(out,null,2) }

    async function callProxy(){ const body = document.getElementById('body').value; let data; try { data = JSON.parse(body) } catch { alert('invalid JSON'); return } const out = await j('POST','/proxy/auto-chat',data); document.getElementById('proxyOut').textContent = JSON.stringify(out,null,2) }

    async function loadConfig(){ const c = await j('GET','/admin/config'); if(!c||typeof c!=='object') return; document.getElementById('cfgAuth').value = String(!!c.requireAuth); document.getElementById('cfgModels').value = (c.allowedModels||[]).join(','); }
    async function saveConfig(){ const requireAuth = document.getElementById('cfgAuth').value==='true'; const allowedModels = (document.getElementById('cfgModels').value||'').split(',').map(s=>s.trim()).filter(Boolean); const out = await j('PATCH','/admin/config',{requireAuth,allowedModels}); alert('saved'); }
  </script>
</body>
</html>
