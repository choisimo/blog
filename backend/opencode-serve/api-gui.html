<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenCode API GUI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root {
      --bg-muted: #f8f9fa;
    }
    body { padding: 20px; }
    .response { max-height: 420px; overflow-y: auto; background: var(--bg-muted); padding: 12px; border-radius: 6px; }
    .request { max-height: 260px; overflow-y: auto; background: #fff8e1; padding: 12px; border-radius: 6px; border: 1px dashed #f0ad4e; }
    @media (max-width: 576px) {
      .request, .response { max-height: 300px; }
    }
    .endpoint-group { margin-bottom: 20px; }
    .param-input { margin-bottom: 10px; }
    .help { font-size: .9rem; color: #6c757d; }
    .copy-btn { cursor: pointer; }
    .spinner-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.6); display: none; align-items: center; justify-content: center; z-index: 1050; }
    .badge-endpoint { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill { border-radius: 999px; padding: .25rem .5rem; background: #e9ecef; }
    pre { white-space: pre-wrap; word-break: break-word; }
    /* Chat UI */
    .chat { max-height: 420px; overflow-y: auto; background: var(--bg-muted); padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; }
    .msg { display: flex; margin-bottom: 8px; }
    .msg.user { justify-content: flex-end; }
    .bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; white-space: pre-wrap; word-break: break-word; }
    .msg.user .bubble { background: #d1e7dd; color: #0f5132; }
    .msg.bot .bubble { background: #e7f1ff; color: #084298; }
    @media (max-width: 576px) {
      .chat { max-height: 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-3">AI 쌀먹 API GUI</h1>

    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-4">
        <label class="form-label">Base URL</label>
        <div class="input-group">
          <input id="baseUrlInput" type="text" class="form-control" placeholder="https://ai-serve.nodove.com" />
          <button id="saveBaseUrlBtn" class="btn btn-outline-secondary">저장</button>
        </div>
        <div class="help">모든 호출은 위 Base URL을 기준으로 요청합니다.</div>
      </div>
      <div class="col-12 col-lg-4">
        <label class="form-label">API Key (선택)</label>
        <input id="apiKeyInput" type="password" class="form-control" placeholder="Bearer YOUR_TOKEN" />
        <div class="form-text">전송 시 헤더에 Authorization으로 포함됩니다.</div>
      </div>
      <div class="col-12 col-lg-4">
        <label class="form-label">Model (허용된 모델만 선택 가능)</label>
        <select id="modelSelect" class="form-select">
          <option value="gpt-4.1">gpt-4.1</option>
          <option value="gpt-4o">gpt-4o</option>
        </select>
        <div class="help">허용: gpt-4.1, gpt-4o. 그 외 절대 불가.</div>
      </div>
    </div>

    <div class="alert alert-info" role="alert">
      처음 사용하셔도 걱정 마세요! 아래에서 버튼을 눌러보면 곧바로 API를 시도할 수 있고, 왼쪽엔 요청 정보(메서드/URL/헤더/바디), 오른쪽엔 응답이 표시됩니다.
    </div>


    <div class="accordion" id="apiAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#projectCollapse">
            Project <span class="ms-2 badge text-bg-secondary badge-endpoint">/project</span><span class="ms-2 text-muted small d-none d-md-inline">프로젝트 목록과 현재 프로젝트 조회</span>
          </button>
        </h2>
        <div id="projectCollapse" class="accordion-collapse collapse show" data-bs-parent="#apiAccordion">
          <div class="accordion-body">
            <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
              <button class="btn btn-primary" onclick="callAPI('GET', '/project')">List Projects</button>
              <span class="pill">GET <code>/project</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/project')">URL 복사</button>
            </div>
            <div class="help mb-3">프로젝트 목록을 반환합니다.</div>
            <div class="d-flex align-items-center flex-wrap gap-2">
              <button class="btn btn-primary" onclick="callAPI('GET', '/project/current')">Current Project</button>
              <span class="pill">GET <code>/project/current</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/project/current')">URL 복사</button>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#configCollapse">
            Config <span class="ms-2 badge text-bg-secondary badge-endpoint">/config</span><span class="ms-2 text-muted small d-none d-md-inline">설정 조회 및 부분 업데이트</span>
          </button>
        </h2>
        <div id="configCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
          <div class="accordion-body">
            <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
              <button class="btn btn-primary" onclick="callAPI('GET', '/config')">Get Config</button>
              <span class="pill">GET <code>/config</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/config')">URL 복사</button>
            </div>
              <div class="param-input">
                <label class="form-label">Config JSON</label>
                <textarea id="configData" class="form-control" rows="4" placeholder='{"key":"value"}'></textarea>
                <div class="d-flex align-items-center gap-2 mt-2 flex-wrap">
                  <button class="btn btn-secondary" onclick="loadCurrentConfig()">현재 설정 불러오기</button>
                  <button class="btn btn-warning" onclick="patchConfig()">Update Config</button>
                  <span class="pill">PATCH <code>/config</code></span>
                  <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/config')">URL 복사</button>
                </div>
                <div class="help mt-1">유효한 JSON만 전송됩니다. JSON이 올바르지 않으면 전송하지 않습니다.</div>
              </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#toolCollapse">
            Tools <span class="ms-2 badge text-bg-secondary badge-endpoint">/experimental</span><span class="ms-2 text-muted small d-none d-md-inline">도구 ID/목록 조회 (모델 제한)</span>
          </button>
        </h2>
        <div id="toolCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
          <div class="accordion-body">
            <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
              <button class="btn btn-primary" onclick="callAPI('GET', '/experimental/tool/ids')">Tool IDs</button>
              <span class="pill">GET <code>/experimental/tool/ids</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/experimental/tool/ids')">URL 복사</button>
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-4">
                <label class="form-label">Provider</label>
                <input type="text" id="toolProvider" class="form-control" placeholder="e.g., openai" value="openai" />
                <div class="help">임의 Provider를 지정할 수 있지만 모델은 강제 제한됩니다.</div>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Model (강제 적용)</label>
                <input type="text" id="toolModel" class="form-control" value="gpt-4.1" disabled />
                <div class="help">상단에서 선택한 모델이 자동 반영됩니다.</div>
              </div>
              <div class="col-12 col-md-4">
                <button class="btn btn-primary w-100" onclick="listTools()">List Tools</button>
                <div class="help">GET <code>/experimental/tool?provider=&lt;provider&gt;&amp;model=&lt;model&gt;</code></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pathCollapse">
            Path <span class="ms-2 badge text-bg-secondary badge-endpoint">/path</span><span class="ms-2 text-muted small d-none d-md-inline">서버의 서비스 경로 확인</span>
          </button>
        </h2>
        <div id="pathCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
          <div class="accordion-body">
            <div class="d-flex align-items-center flex-wrap gap-2">
              <button class="btn btn-primary" onclick="callAPI('GET', '/path')">Get Path</button>
              <span class="pill">GET <code>/path</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/path')">URL 복사</button>
            </div>
            <div class="help mt-2">서버가 제공하는 기본 경로 정보를 제공합니다.</div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sessionCollapse">
            Sessions <span class="ms-2 badge text-bg-secondary badge-endpoint">/session</span><span class="ms-2 text-muted small d-none d-md-inline">세션 생성/조회/삭제</span>
          </button>
        </h2>
        <div id="sessionCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
          <div class="accordion-body">
            <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
              <button class="btn btn-primary" onclick="listSessionsUI()">List Sessions</button>
              <span class="pill">GET <code>/session</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/session')">URL 복사</button>
            </div>
            <div id="sessionList" class="mb-3"></div>

            <div class="row g-2 align-items-end mb-3">
              <div class="col-12 col-md-8">
                <label class="form-label">Title</label>
                <input type="text" id="sessionTitle" class="form-control" placeholder="Session title" />
              </div>
              <div class="col-12 col-md-4">
                <button class="btn btn-success w-100" onclick="createSession()">Create Session</button>
                <div class="help">POST <code>/session</code> body: {"title": "..."}</div>
              </div>
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-8">
                <label class="form-label">Session ID</label>
                <input type="text" id="sessionId" class="form-control" placeholder="ses_..." />
              </div>
              <div class="col-12 col-md-4 d-flex gap-2">
                <button class="btn btn-info flex-fill" onclick="getSession()">Get</button>
                <button class="btn btn-danger flex-fill" onclick="deleteSession()">Delete</button>
              </div>
              <div class="col-12 help">GET/DELETE <code>/session/{id}</code></div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#chatCollapse">
            Chat <span class="ms-2 text-muted small d-none d-md-inline">세션과 대화하고 응답 확인</span>
          </button>
        </h2>
        <div id="chatCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
          <div class="accordion-body">
            <div class="row g-2 align-items-end mb-2">
              <div class="col-12 col-md-8">
                <label class="form-label">Session ID</label>
                <input type="text" id="chatSessionId" class="form-control" placeholder="ses_..." />
              </div>
              <div class="col-12 col-md-4 d-flex gap-2">
                <button class="btn btn-outline-secondary flex-fill" onclick="chatUseCurrentSession()">상단 Session 사용</button>
              </div>
            </div>

            <div id="chatTranscript" class="chat mb-2"></div>

            <div class="row g-2 align-items-end">
              <div class="col-12">
                <label class="form-label">메시지</label>
                <textarea id="chatInput" class="form-control" rows="3" placeholder="메시지를 입력하세요..."></textarea>
              </div>
              <div class="col-12 d-flex gap-2 mt-2">
                <button id="chatSendBtn" class="btn btn-primary" onclick="chatSend()">Send</button>
                <button id="chatStopBtn" class="btn btn-outline-danger" onclick="chatStop()" disabled>Stop</button>
                <button class="btn btn-outline-secondary ms-auto" onclick="chatClear()">Clear</button>
              </div>
              <div class="col-12 help">POST <code>/session/{id}/message</code> body: {"content": "...", "model": "gpt-4.1|gpt-4o"}. Stream은 실험적 옵션입니다.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#otherCollapse">
            Other <span class="ms-2 text-muted small d-none d-md-inline">명령/프로바이더/에이전트 조회</span>
          </button>
        </h2>
        <div id="otherCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
          <div class="accordion-body">
            <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
              <button class="btn btn-primary" onclick="callAPI('GET', '/command')">List Commands</button>
              <span class="pill">GET <code>/command</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/command')">URL 복사</button>
            </div>
            <div class="help mb-3">사용 가능한 서버 명령을 나열합니다.</div>
            <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
              <button class="btn btn-primary" onclick="callAPI('GET', '/config/providers')">List Providers</button>
              <span class="pill">GET <code>/config/providers</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/config/providers')">URL 복사</button>
            </div>
            <div class="help mb-3">등록된 AI Provider 목록을 조회합니다.</div>
            <div class="d-flex align-items-center flex-wrap gap-2">
              <button class="btn btn-primary" onclick="callAPI('GET', '/agent')">List Agents</button>
              <span class="pill">GET <code>/agent</code></span>
              <button class="btn btn-outline-secondary btn-sm copy-btn" onclick="copyUrl('/agent')">URL 복사</button>
            </div>
            <div class="help mt-2">사용 가능한 에이전트를 조회합니다.</div>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedCollapse">
            Advanced <span class="ms-2 text-muted small">요청 빌더(고급)</span>
          </button>
        </h2>
        <div id="advancedCollapse" class="accordion-collapse collapse" data-bs-parent="#apiAccordion">
          <div class="accordion-body">
            <div class="card border-secondary">
              <div class="card-body">
                <div class="row g-2 align-items-end mb-2">
                  <div class="col-12 col-md-5">
                    <label class="form-label">템플릿</label>
                    <select id="rbTemplate" class="form-select"></select>
                    <div class="help">자주 쓰는 엔드포인트를 빠르게 불러옵니다.</div>
                  </div>
                  <div class="col-6 col-md-3">
                    <label class="form-label">Method</label>
                    <select id="rbMethod" class="form-select">
                      <option>GET</option>
                      <option>POST</option>
                      <option>PATCH</option>
                      <option>DELETE</option>
                    </select>
                  </div>
                  <div class="col-6 col-md-4">
                    <label class="form-label">Path</label>
                    <input id="rbPath" type="text" class="form-control" placeholder="/example" />
                    <div class="help">반드시 '/' 로 시작합니다.</div>
                  </div>
                </div>

                <div class="mb-2">
                  <div class="d-flex align-items-center justify-content-between">
                    <label class="form-label mb-0">Query Params</label>
                    <button class="btn btn-outline-secondary btn-sm" onclick="rbAddRow('rbQueryRows')">행 추가</button>
                  </div>
                  <div id="rbQueryRows" class="mt-2"></div>
                  <div class="help">비어있는 key는 무시됩니다. 모델 파라미터는 제한됩니다.</div>
                </div>

                <div class="mb-2">
                  <div class="row g-2">
                    <div class="col-12 col-md-4">
                      <label class="form-label">Body</label>
                      <select id="rbBodyMode" class="form-select">
                        <option value="none">없음</option>
                        <option value="kv">Key-Value</option>
                        <option value="raw">Raw JSON</option>
                      </select>
                      <div class="help">JSON 유효성 검사 및 모델 제한을 적용합니다.</div>
                    </div>
                    <div class="col-12 col-md-8">
                      <div id="rbBodyKV" style="display:none"></div>
                      <textarea id="rbBodyRaw" class="form-control" rows="4" style="display:none" placeholder='{"key":"value"}'></textarea>
                      <div id="rbKvAddWrap" class="d-flex gap-2 mt-2" style="display:none">
                        <button class="btn btn-outline-secondary btn-sm" onclick="rbAddRow('rbBodyKV')">KV 행 추가</button>
                      </div>
                    </div>
                  </div>
                  <div class="help mt-1">/experimental/tool 호출 시 model 미지정이면 상단 선택 모델을 자동 적용합니다.</div>
                </div>

                <div class="d-flex gap-2">
                  <button class="btn btn-primary" onclick="rbSend()">Send</button>
                  <button class="btn btn-outline-secondary" onclick="rbReset()">Reset</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
 
     <div class="row g-3 mt-4">
      <div class="col-12 col-lg-6">
        <h5 class="mb-2">Request</h5>
        <pre id="request" class="request"></pre>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="copyText('request')">요청 복사</button>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <h5 class="mb-2">Response</h5>
        <pre id="response" class="response"></pre>
        <div id="statusLine" class="help mt-2"></div>
        <div class="d-flex gap-2 mt-2">
          <button class="btn btn-outline-secondary btn-sm" onclick="copyText('response')">응답 복사</button>
        </div>
      </div>
    </div>
  </div>

  <div id="spinner" class="spinner-overlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const ALLOWED_MODELS = ['gpt-4.1', 'gpt-4o'];

    // State + persistence
    const baseURLDefault = 'https://ai-serve.nodove.com';
    const baseUrlInput = document.getElementById('baseUrlInput');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const modelSelect = document.getElementById('modelSelect');
    const toolModelInput = document.getElementById('toolModel');

    function loadState() {
      const savedBase = localStorage.getItem('oc_base_url') || baseURLDefault;
      const savedKey = localStorage.getItem('oc_api_key') || '';
      const savedModel = localStorage.getItem('oc_model') || ALLOWED_MODELS[0];

      baseUrlInput.value = savedBase;
      apiKeyInput.value = savedKey;
      if (ALLOWED_MODELS.includes(savedModel)) {
        modelSelect.value = savedModel;
      } else {
        modelSelect.value = ALLOWED_MODELS[0];
      }
      reflectToolModel();
    }

    function reflectToolModel() {
      if (toolModelInput) {
        toolModelInput.value = modelSelect.value;
      }
    }

    document.getElementById('saveBaseUrlBtn').addEventListener('click', () => {
      const url = (baseUrlInput.value || '').trim();
      if (!/^https?:\/\//i.test(url)) {
        alert('Base URL은 http(s)로 시작해야 합니다.');
        return;
      }
      localStorage.setItem('oc_base_url', url);
      showToast('Base URL 저장됨');
    });

    apiKeyInput.addEventListener('change', () => {
      localStorage.setItem('oc_api_key', apiKeyInput.value.trim());
    });

    modelSelect.addEventListener('change', () => {
      const val = modelSelect.value;
      if (!ALLOWED_MODELS.includes(val)) {
        alert('허용되지 않은 모델입니다. gpt-4.1 또는 gpt-4o만 가능합니다.');
        modelSelect.value = ALLOWED_MODELS[0];
      }
      localStorage.setItem('oc_model', modelSelect.value);
      reflectToolModel();
    });

    function assertAllowedModel(model) {
      if (!ALLOWED_MODELS.includes(model)) {
        throw new Error('허용되지 않은 모델(' + model + ')은 사용할 수 없습니다. gpt-4.1 또는 gpt-4o만 선택 가능합니다.');
      }
    }

    function enforceAllowedModelsInBody(obj) {
      if (!obj || typeof obj !== 'object') return;
      const stack = [obj];
      while (stack.length) {
        const cur = stack.pop();
        if (!cur || typeof cur !== 'object') continue;
        
        const checkValue = (val) => {
          if (typeof val === 'string') {
            assertAllowedModel(val);
          } else if (val && typeof val === 'object') {
            const cand = val.id || val.name || val.model || val.modelId || val.modelID;
            if (typeof cand === 'string') assertAllowedModel(cand);
          }
        };

        const entries = Array.isArray(cur) ? cur.entries() : Object.entries(cur);
        for (const [k, v] of entries) {
          const key = Array.isArray(cur) ? String(k) : k;
          const norm = String(key).replace(/[-_]/g, '').toLowerCase();
          if (norm === 'model' || norm === 'modelid') {
            checkValue(v);
          }
          if (v && typeof v === 'object') {
            stack.push(v);
          }
        }
      }
    }

    // Helpers
    function getBaseURL() { return (baseUrlInput.value || baseURLDefault).trim(); }
    function copyUrl(endpoint) { copyToClipboard(getBaseURL() + endpoint); showToast('URL 복사됨'); }
    function copyText(elId) { copyToClipboard(document.getElementById(elId).textContent); showToast('복사됨'); }
    function copyToClipboard(text) { navigator.clipboard?.writeText(text); }
    function showToast(message) { console.log(message); }

    function showSpinner(visible) {
      document.getElementById('spinner').style.display = visible ? 'flex' : 'none';
    }

    function renderRequestPreview({ method, url, headers, body }) {
      const req = { method, url, headers, body: body ? JSON.parse(body) : undefined };
      document.getElementById('request').textContent = JSON.stringify(req, null, 2);
    }

    async function callAPI(method, endpoint, body = null, extraHeaders = {}) {
      const baseURL = getBaseURL();
      const url = baseURL + endpoint;

      try {
        // Always enforce model restrictions for any request that specifies a model
        try {
          const urlObj = new URL(url);
          for (const [key, value] of urlObj.searchParams.entries()) {
            const normKey = key.replace(/[-_]/g, '').toLowerCase();
            if (normKey === 'model' || normKey === 'modelid') {
              assertAllowedModel(value.trim());
            }
          }
        } catch {
          // Ignore URL parsing issues; fetch will handle invalid URLs later
        }

        let bodyForEnforcement = body;
        if (body && typeof body === 'string') {
          try {
            bodyForEnforcement = JSON.parse(body);
          } catch {
            bodyForEnforcement = null;
          }
        }

        if (bodyForEnforcement && typeof bodyForEnforcement === 'object') {
          enforceAllowedModelsInBody(bodyForEnforcement);
        }
      } catch (e) {
        alert(e.message);
        document.getElementById('response').textContent = 'Error: ' + e.message;
        document.getElementById('statusLine').textContent = 'Request Blocked';
        return; // Stop the request from being sent
      }
      
      const headers = {
        'Content-Type': 'application/json',
        ...extraHeaders,
      };
      const key = (apiKeyInput.value || '').trim();
      if (key) headers['Authorization'] = key.startsWith('Bearer ') ? key : `Bearer ${key}`;

      const options = { method, headers };
      if (body) options.body = typeof body === 'string' ? body : JSON.stringify(body);

      renderRequestPreview({ method, url, headers: options.headers, body: options.body || '' });

      const start = performance.now();
      showSpinner(true);
      let outData = null;
      try {
        const resp = await fetch(url, options);
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }
        const ms = Math.round(performance.now() - start);
        document.getElementById('response').textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        document.getElementById('statusLine').textContent = `Status: ${resp.status} ${resp.statusText || ''} • ${ms} ms`;
        outData = data;
        return outData;
      } catch (error) {
        document.getElementById('response').textContent = 'Error: ' + error.message;
        document.getElementById('statusLine').textContent = '';
        throw error;
      } finally {
        showSpinner(false);
      }
    }

    // Request Builder
    const RB_TEMPLATES = [
      { name: 'GET /app', method: 'GET', path: '/app' },
      { name: 'GET /config', method: 'GET', path: '/config' },
      { name: 'GET /config/providers', method: 'GET', path: '/config/providers' },
      { name: 'GET /project', method: 'GET', path: '/project' },
      { name: 'GET /project/current', method: 'GET', path: '/project/current' },
      { name: 'GET /session', method: 'GET', path: '/session' },
      { name: 'POST /session', method: 'POST', path: '/session', bodyKV: [{ k: 'title', v: '' }] },
      { name: 'GET /session/{id}', method: 'GET', path: '/session/{id}' },
      { name: 'DELETE /session/{id}', method: 'DELETE', path: '/session/{id}' },
      { name: 'GET /path', method: 'GET', path: '/path' },
      { name: 'GET /command', method: 'GET', path: '/command' },
      { name: 'GET /agent', method: 'GET', path: '/agent' },
      { name: 'GET /experimental/tool/ids', method: 'GET', path: '/experimental/tool/ids' },
      { name: 'GET /experimental/tool', method: 'GET', path: '/experimental/tool', queryKV: [{ k: 'provider', v: 'openai' }, { k: 'model', v: 'gpt-4.1' }] },
       { name: 'POST /session/{id}/message', method: 'POST', path: '/session/{id}/message', bodyRaw: '{\n  "providerID": "openai",\n  "modelID": "gpt-4.1",\n  "parts": [\n    { "type": "text", "text": "" }\n  ]\n}' },
    ];

    const rbTemplate = document.getElementById('rbTemplate');
    const rbMethod = document.getElementById('rbMethod');
    const rbPath = document.getElementById('rbPath');
    const rbQueryRows = document.getElementById('rbQueryRows');
    const rbBodyMode = document.getElementById('rbBodyMode');
    const rbBodyKV = document.getElementById('rbBodyKV');
    const rbBodyRaw = document.getElementById('rbBodyRaw');
    const rbKvAddWrap = document.getElementById('rbKvAddWrap');

    function rbPopulateTemplates() {
      rbTemplate.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '직접 입력';
      rbTemplate.appendChild(opt);
      RB_TEMPLATES.forEach((t, i) => {
        const o = document.createElement('option');
        o.value = String(i);
        o.textContent = t.name;
        rbTemplate.appendChild(o);
      });
    }

    function rbSetRows(container, kvs) {
      container.innerHTML = '';
      (kvs || []).forEach(({ k, v }) => rbAddRow(container.id, k, v));
    }

    function rbOnTemplateChange() {
        const idx = rbTemplate.value ? parseInt(rbTemplate.value, 10) : -1;
        if (idx < 0) {
            rbReset();
            return;
        }
        const t = RB_TEMPLATES[idx];
        rbMethod.value = t.method;
        rbPath.value = t.path;
        rbSetRows(rbQueryRows, t.queryKV || []);
        
        if (t.bodyRaw) {
            rbBodyMode.value = 'raw';
            rbBodyKV.style.display = 'none';
            rbKvAddWrap.style.display = 'none';
            rbBodyRaw.style.display = '';
            rbBodyRaw.value = t.bodyRaw;
            rbBodyKV.innerHTML = '';
        } else if (t.bodyKV && t.bodyKV.length) {
            rbBodyMode.value = 'kv';
            rbBodyRaw.style.display = 'none';
            rbBodyRaw.value = '';
            rbKvAddWrap.style.display = '';
            rbBodyKV.style.display = '';
            rbSetRows(rbBodyKV, t.bodyKV);
        } else {
            rbBodyMode.value = 'none';
            rbBodyKV.style.display = 'none';
            rbKvAddWrap.style.display = 'none';
            rbBodyRaw.style.display = 'none';
            rbBodyRaw.value = '';
            rbBodyKV.innerHTML = '';
        }
        rbBodyMode.dispatchEvent(new Event('change'));
    }

    function rbAddRow(containerId, key = '', val = '') {
      const container = document.getElementById(containerId);
      const row = document.createElement('div');
      row.className = 'row g-2 mb-2';
      row.innerHTML = `
        <div class="col-5"><input class="form-control rb-k" placeholder="key" value="${key}" /></div>
        <div class="col-5"><input class="form-control rb-v" placeholder="value" value="${val}" /></div>
        <div class="col-2 d-grid"><button class="btn btn-outline-danger btn-sm" type="button">삭제</button></div>
      `;
      row.querySelector('button').addEventListener('click', () => row.remove());
      container.appendChild(row);
    }

    rbBodyMode.addEventListener('change', (e) => {
      const mode = e.target.value;
      rbKvAddWrap.style.display = (mode === 'kv') ? 'flex' : 'none';
      rbBodyKV.style.display = (mode === 'kv') ? '' : 'none';
      rbBodyRaw.style.display = (mode === 'raw') ? '' : 'none';
    });
    
    rbTemplate.addEventListener('change', rbOnTemplateChange);

    function rbCollectKV(container) {
      const rows = Array.from(container.querySelectorAll('.row'));
      const obj = {};
      for (const r of rows) {
        const k = r.querySelector('.rb-k').value.trim();
        if (!k) continue;
        const v = r.querySelector('.rb-v').value;
        obj[k] = v;
      }
      return obj;
    }

    function rbBuildPathWithParams(path, params) {
      const usp = new URLSearchParams(params);
      const q = usp.toString();
      return q ? `${path}?${q}` : path;
    }

    function rbBuildBody() {
      const mode = rbBodyMode.value;
      if (mode === 'none') return null;
      if (mode === 'kv') return rbCollectKV(rbBodyKV);
      const raw = rbBodyRaw.value.trim();
      if (!raw) return null;
      try { return JSON.parse(raw); } catch {
        alert('Body가 유효한 JSON이 아닙니다.');
        throw new Error('Invalid JSON');
      }
    }

    function rbReset() {
      rbTemplate.value = '';
      rbMethod.value = 'GET';
      rbPath.value = '';
      rbQueryRows.innerHTML = '';
      rbBodyMode.value = 'none';
      rbBodyKV.innerHTML = '';
      rbBodyRaw.value = '';
      rbBodyMode.dispatchEvent(new Event('change'));
    }

    function rbSend() {
      const method = rbMethod.value;
      let path = rbPath.value.trim();
      if (!path.startsWith('/')) {
        alert('Path는 /로 시작해야 합니다.');
        return;
      }
      const qp = rbCollectKV(rbQueryRows);
      
      // 편의 기능: /experimental/tool에 model 미기입 시 상단 선택 반영
      if (path.startsWith('/experimental/tool') && !('model' in qp)) {
        const model = modelSelect.value;
        qp.model = model;
      }

      path = rbBuildPathWithParams(path, qp);
      
      try {
        const body = rbBuildBody();
        callAPI(method, path, body);
      } catch (e) {
        // Error already alerted in rbBuildBody
      }
    }

    rbPopulateTemplates();

    // Specific handlers
    function patchConfig() {
      const val = document.getElementById('configData').value;
      if (!val.trim()) return alert('Config JSON을 입력해 주세요.');
      try {
        const parsed = JSON.parse(val);
        return callAPI('PATCH', '/config', parsed);
      } catch (e) {
        alert('유효한 JSON이 아닙니다. 다시 확인해 주세요.');
      }
    }

    async function loadCurrentConfig() {
      const data = await callAPI('GET', '/config');
      try {
        document.getElementById('configData').value = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
      } catch {}
    }

    function listTools() {
      const provider = document.getElementById('toolProvider').value.trim() || 'openai';
      const model = modelSelect.value;
      const q = `/experimental/tool?provider=${encodeURIComponent(provider)}&model=${encodeURIComponent(model)}`;
      return callAPI('GET', q);
    }

    async function createSession() {
      const title = document.getElementById('sessionTitle').value.trim();
      if (!title) return alert('Title을 입력해 주세요.');
      const data = await callAPI('POST', '/session', { title });
      try {
        const id = data && (data.id || data.sessionId || data.session?.id);
        if (id) {
          document.getElementById('sessionId').value = id;
        }
      } catch {}
    }

    function getSession() {
      const id = document.getElementById('sessionId').value.trim();
      if (!id) return alert('Session ID를 입력해 주세요.');
      return callAPI('GET', `/session/${encodeURIComponent(id)}`);
    }

    function deleteSession() {
      const id = document.getElementById('sessionId').value.trim();
      if (!id) return alert('Session ID를 입력해 주세요.');
      return callAPI('DELETE', `/session/${encodeURIComponent(id)}`);
    }

    async function listSessionsUI() {
      const data = await callAPI('GET', '/session');
      const container = document.getElementById('sessionList');
      try {
        const arr = Array.isArray(data) ? data : (data?.sessions || []);
        if (!arr.length) { container.innerHTML = '<div class="help">세션이 없습니다.</div>'; return; }
        container.innerHTML = arr.map(it => {
          const id = it.id || it.sessionId || '';
          const title = it.title || '(untitled)';
          return `<div class="d-flex align-items-center justify-content-between border rounded p-2 mb-2">
            <div>
              <div class="fw-semibold">${title}</div>
              <div class="text-muted small">${id}</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" onclick="useSession('${id}')">사용</button>
            </div>
          </div>`;
        }).join('');
      } catch (e) {
        container.innerHTML = '';
      }
    }

    function useSession(id) {
      if (!id) return;
      document.getElementById('sessionId').value = id;
    }

    // Chat helpers and handlers
    let chatAbortController = null;

    function chatUseCurrentSession() {
      const sid = document.getElementById('sessionId')?.value.trim();
      if (!sid) { alert('상단 Session ID가 비어있습니다.'); return; }
      const chatSid = document.getElementById('chatSessionId');
      if (chatSid) chatSid.value = sid;
    }

    function chatClear() {
      const el = document.getElementById('chatTranscript');
      if (el) el.innerHTML = '';
    }

    function appendChatMessage(role, text) {
      const c = document.getElementById('chatTranscript');
      if (!c) return null;
      const wrap = document.createElement('div');
      wrap.className = `msg ${role}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text || '';
      wrap.appendChild(bubble);
      c.appendChild(wrap);
      c.scrollTop = c.scrollHeight;
      return bubble;
    }

    function chatSetBusy(busy) {
      const sendBtn = document.getElementById('chatSendBtn');
      const stopBtn = document.getElementById('chatStopBtn');
      if (sendBtn) sendBtn.disabled = !!busy;
      if (stopBtn) stopBtn.disabled = !busy;
    }

    function chatStop() {
      if (chatAbortController) {
        try { chatAbortController.abort(); } catch {}
      }
    }

    function extractBotText(data) {
      if (data == null) return '';
      if (typeof data === 'string') return data;
      if (typeof data === 'object') {
        if (typeof data.content === 'string') return data.content;
        if (typeof data.message === 'string') return data.message;
        if (typeof data.reply === 'string') return data.reply;
        if (typeof data.text === 'string') return data.text;

        const collectTexts = (containers) => {
          if (!Array.isArray(containers)) return [];
          return containers.flatMap((item) => {
            const contentParts = item?.content || item?.parts;
            if (!Array.isArray(contentParts)) return [];
            return contentParts
              .filter((part) => typeof part?.text === 'string')
              .map((part) => part.text);
          });
        };

        const directParts = data.parts || data.output?.parts || data.message?.parts || data.data?.parts;
        const directTexts = Array.isArray(directParts) ? directParts.map((p) => p?.text).filter(Boolean) : [];

        const outputTexts = collectTexts(data.output) || collectTexts(data.response?.output) || [];
        const messageArrayTexts = collectTexts(data.messages);

        const allTexts = [...directTexts, ...outputTexts, ...messageArrayTexts];
        if (allTexts.length) return allTexts.join('');

        if (Array.isArray(data.messages)) {
          const last = data.messages[data.messages.length - 1];
          if (last && typeof last.content === 'string') return last.content;
        }
        try { return JSON.stringify(data, null, 2); } catch {}
      }
      return String(data);
    }

    async function chatSend() {
      const sidInput = document.getElementById('chatSessionId');
      const sidFallback = document.getElementById('sessionId');
      const sessionId = (sidInput?.value || sidFallback?.value || '').trim();
      if (!sessionId) { alert('Session ID를 먼저 입력/선택해 주세요.'); return; }

      const input = document.getElementById('chatInput');
      const content = (input?.value || '').trim();
      if (!content) { alert('메시지를 입력해 주세요.'); return; }

      const modelId = document.getElementById('modelSelect').value;
      
      const body = {
        providerID: 'openai', // Hardcoded since both allowed models are from openai
        modelID: modelId,
        parts: [
          {
            type: 'text',
            text: content
          }
        ]
      };
      
      appendChatMessage('user', content);
      if (input) input.value = '';

      const stream = document.getElementById('chatStream')?.checked;
      const endpoint = `/session/${encodeURIComponent(sessionId)}/message`;

      if (stream) {
        await chatSendStreaming(endpoint, body);
      } else {
        try {
          chatSetBusy(true);
          const data = await callAPI('POST', endpoint, body);
          const text = extractBotText(data);
          appendChatMessage('bot', text);
        } catch (e) {
          appendChatMessage('bot', 'Error: ' + (e?.message || e));
        } finally {
          chatSetBusy(false);
        }
      }
    }

    async function chatSendStreaming(endpoint, body) {
      const baseURL = getBaseURL();
      const url = baseURL + endpoint;
      const headers = { 'Content-Type': 'application/json' };
      const key = (apiKeyInput.value || '').trim();
      if (key) headers['Authorization'] = key.startsWith('Bearer ') ? key : `Bearer ${key}`;
      headers['Accept'] = 'text/event-stream, text/plain;q=0.9, */*;q=0.1';

      // Manually run model check before fetch since callAPI is bypassed
      try {
        enforceAllowedModelsInBody(body);
      } catch (e) {
        alert(e.message);
        appendChatMessage('bot', 'Error: ' + e.message);
        return;
      }
      
      renderRequestPreview({ method: 'POST', url, headers, body: JSON.stringify(body) });

      chatAbortController = new AbortController();
      chatSetBusy(true);
      showSpinner(true);
      const start = performance.now();

      const botBubble = appendChatMessage('bot', '');
      let accum = '';
      try {
        const resp = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body), signal: chatAbortController.signal });
        const reader = resp.body?.getReader();
        const decoder = new TextDecoder();
        if (reader) {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            accum += chunk;
            if (botBubble) botBubble.textContent = accum;
            const c = document.getElementById('chatTranscript');
            if (c) c.scrollTop = c.scrollHeight;
          }
        } else {
          accum = await resp.text();
          if (botBubble) botBubble.textContent = accum;
        }
        const ms = Math.round(performance.now() - start);
        document.getElementById('response').textContent = accum;
        document.getElementById('statusLine').textContent = `Status: ${resp.status} ${resp.statusText || ''} • ${ms} ms`;
      } catch (e) {
        if (botBubble) botBubble.textContent = (accum || '') + `\n[Error] ${e?.name === 'AbortError' ? '중단됨' : (e?.message || e)}`;
      } finally {
        showSpinner(false);
        chatSetBusy(false);
        chatAbortController = null;
      }
    }

    // Enter to send (Shift+Enter for newline)
    (function initChatKeybind() {
      const el = document.getElementById('chatInput');
      if (!el) return;
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatSend();
        }
      });
    })();

    // Init
    loadState();
  </script>
</body>
</html>