# Docker Deployment Guide

Complete guide for deploying the blog backend infrastructure using Docker Compose.

## Overview

The stack uses `docker-compose.blog-workflow.yml` for production deployment via CI/CD (GitHub Actions). All custom services use pre-built images from GitHub Container Registry (GHCR).

**Deployment Directory:** `/opt/blog-stack`

**Required Files:**
- `docker-compose.blog-workflow.yml`
- `.env` (generated by CI/CD or copied from `.env.example`)
- `nginx.conf` (reverse proxy configuration)
- `ssl/` directory (SSL certificates)
- `n8n-workflows/` (optional, mounted read-only)

---

## Service Architecture

### Infrastructure Services

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| postgres | postgres:16-alpine | 5432 (localhost) | Primary database |
| redis | redis:7-alpine | 6379 (localhost) | Cache & queue backend |
| chromadb | chromadb/chroma:0.5.23 | 8000 (internal) | Vector database for embeddings |

### Application Services

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| nginx | nginx:alpine | 80, 443, 8080, 8443 | Reverse proxy with SSL |
| api | ghcr.io/.../blog-api | 5080 (internal) | Main backend API |
| terminal-server | ghcr.io/.../blog-terminal | 8080 (internal) | WebSocket terminal sandbox |
| embedding-server | huggingface/text-embeddings-inference | 80 (internal) | Text embeddings (MiniLM-L6-v2) |

### AI Services

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| noaicode (ai-server-serve) | ghcr.io/.../ai-server-serve | 7015:7012 | LLM provider backend |
| ai-server-backend | ghcr.io/.../ai-server-backend | 7016 (internal) | AI adapter API |

### Workflow Engine

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| n8n | n8nio/n8n | 5678 (localhost) | Workflow automation engine |
| n8n-worker | n8nio/n8n | - | Queue workers (2 replicas default) |

### Utility Services

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| minio | minio/minio | 9000, 9001 (localhost) | S3-compatible object storage |

---

## Optional Profiles

### Monitoring Profile

Enable with `--profile monitoring`:

```bash
docker compose -f docker-compose.blog-workflow.yml --profile monitoring up -d
```

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| prometheus | prom/prometheus:v2.48.0 | 9090 (localhost) | Metrics collection |
| grafana | grafana/grafana:10.2.2 | 3001 (localhost) | Metrics visualization |

### Admin Profile

Enable with `--profile admin`:

```bash
docker compose -f docker-compose.blog-workflow.yml --profile admin up -d
```

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| pgadmin | dpage/pgadmin4:8.2 | 5050 (localhost) | PostgreSQL admin UI |
| redis-insight | redis/redisinsight:1.14.0 | 8001 (localhost) | Redis admin UI |

---

## Network Configuration

All services connect via the `blog-network` bridge network.

**Internal DNS aliases:**
- `ai-server-serve`, `ai-serve` -> noaicode container
- `ai-server-backend`, `ai-backend` -> ai-server-backend container

**Service Discovery URLs (internal):**
```
postgres:5432
redis:6379
chromadb:8000
api:5080
n8n:5678
ai-server-serve:7012
ai-server-backend:7016
```

---

## Volume Mounts

### Persistent Data Volumes

| Volume | Container Path | Purpose |
|--------|----------------|---------|
| postgres_data | /var/lib/postgresql/data | Database files |
| redis_data | /data | Redis AOF persistence |
| chroma_data | /chroma/chroma | Vector embeddings |
| n8n_data | /home/node/.n8n | n8n workflows & credentials |
| tei_data | /data | Embedding model cache |
| minio_data | /data | Object storage |
| noaicode-data | /home/appuser/.local/share/opencode | AI server data |
| noaicode-logs | /var/log/opencode | AI server logs |

### Host Bind Mounts

| Host Path | Container Path | Service | Purpose |
|-----------|----------------|---------|---------|
| ./nginx.conf | /etc/nginx/conf.d/default.conf | nginx | Reverse proxy config |
| ./ssl | /etc/nginx/ssl | nginx | SSL certificates |
| ./n8n_files | /files | n8n, n8n-worker | File storage |
| ./n8n-workflows | /workflows | n8n | Workflow definitions (read-only) |
| /var/run/docker.sock | /var/run/docker.sock | terminal-server | Docker API access (read-only) |

---

## Environment Variables

### Required Variables

**Database:**
```env
POSTGRES_DB=blog
POSTGRES_USER=blog
POSTGRES_PASSWORD=<secure-password>
REDIS_PASSWORD=<secure-password>
```

**Security:**
```env
BACKEND_SECRET_KEY=<openssl rand -hex 32>
ORIGIN_SECRET_KEY=<openssl rand -hex 32>
JWT_SECRET=<openssl rand -hex 32>
ADMIN_BEARER_TOKEN=<secure-token>
```

**n8n:**
```env
N8N_USER=admin
N8N_PASS=<secure-password>
N8N_ENCRYPTION_KEY=<openssl rand -hex 32>
N8N_WEBHOOK_URL=https://your-domain.com/
N8N_HOST=your-domain.com
N8N_EDITOR_BASE_URL=https://your-domain.com
```

**Cloudflare (if using D1/R2):**
```env
CF_ACCOUNT_ID=<account-id>
CF_API_TOKEN=<api-token>
D1_DATABASE_ID=<database-id>
R2_BUCKET_NAME=blog
R2_ASSETS_BASE_URL=https://assets.your-domain.com
```

### Optional Variables

**AI Providers:**
```env
AI_PROVIDER=opencode
OPENCODE_DEFAULT_PROVIDER=github-copilot
OPENCODE_DEFAULT_MODEL=gpt-4.1
GOOGLE_API_KEY=<optional>
OPENAI_API_KEY=<optional>
ANTHROPIC_API_KEY=<optional>
```

**Scaling:**
```env
N8N_WORKER_REPLICAS=2
```

**Monitoring:**
```env
GRAFANA_PASSWORD=<password>
```

**Admin Tools:**
```env
PGADMIN_EMAIL=admin@example.com
PGADMIN_PASSWORD=<password>
```

---

## Deployment Commands

### Initial Deployment

```bash
# Navigate to deployment directory
cd /opt/blog-stack

# Pull latest images
docker compose -f docker-compose.blog-workflow.yml pull

# Start all services
docker compose -f docker-compose.blog-workflow.yml up -d

# Check status
docker compose -f docker-compose.blog-workflow.yml ps
```

### With Optional Profiles

```bash
# With monitoring
docker compose -f docker-compose.blog-workflow.yml --profile monitoring up -d

# With admin tools
docker compose -f docker-compose.blog-workflow.yml --profile admin up -d

# With both
docker compose -f docker-compose.blog-workflow.yml --profile monitoring --profile admin up -d
```

### Update Services

```bash
# Pull and restart specific service
docker compose -f docker-compose.blog-workflow.yml pull api
docker compose -f docker-compose.blog-workflow.yml up -d api

# Pull and restart all
docker compose -f docker-compose.blog-workflow.yml pull
docker compose -f docker-compose.blog-workflow.yml up -d
```

### View Logs

```bash
# All services
docker compose -f docker-compose.blog-workflow.yml logs -f

# Specific service
docker compose -f docker-compose.blog-workflow.yml logs -f api

# Last 100 lines
docker compose -f docker-compose.blog-workflow.yml logs --tail=100 api
```

### Stop Services

```bash
# Stop all
docker compose -f docker-compose.blog-workflow.yml down

# Stop and remove volumes (DESTRUCTIVE)
docker compose -f docker-compose.blog-workflow.yml down -v
```

---

## SSL/TLS Configuration

### Cloudflare Full Mode

The stack is designed for Cloudflare Full (Strict) SSL mode:

1. Cloudflare terminates external SSL
2. Origin rules route traffic to port 8443
3. Nginx terminates internal SSL with origin certificate

**Required files in `./ssl/`:**
- `cert.pem` - Cloudflare Origin Certificate
- `key.pem` - Private key

### Nginx SSL Configuration

The `nginx.conf` should include:

```nginx
server {
    listen 443 ssl;
    listen 8443 ssl;
    
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # Routes
    location /api/ {
        proxy_pass http://api:5080;
    }
    
    location /webhook/ {
        proxy_pass http://n8n:5678;
    }
    
    location /terminal/ {
        proxy_pass http://terminal-server:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## Health Checks

All critical services have health checks configured:

| Service | Check | Interval | Timeout |
|---------|-------|----------|---------|
| postgres | pg_isready | 10s | 5s |
| redis | redis-cli ping | 10s | 3s |
| chromadb | HTTP /api/v1/heartbeat | 30s | 10s |
| nginx | curl /health | 30s | 10s |
| api | wget /api/v1/healthz | 30s | 10s |
| noaicode | curl / | 30s | 10s |

---

## Troubleshooting

### Service Won't Start

```bash
# Check logs
docker compose -f docker-compose.blog-workflow.yml logs <service>

# Check health status
docker inspect --format='{{.State.Health.Status}}' blog-<service>
```

### Database Connection Issues

```bash
# Test postgres
docker exec -it blog-postgres psql -U blog -d blog -c "SELECT 1"

# Test redis
docker exec -it blog-redis redis-cli -a $REDIS_PASSWORD ping
```

### n8n Webhook Issues

1. Verify `N8N_WEBHOOK_URL` matches your public domain
2. Check nginx is routing `/webhook/*` to n8n
3. Verify SSL certificates are valid

### Memory Issues

Adjust memory limits in environment:
```env
# n8n main
NODE_OPTIONS=--max-old-space-size=4096

# n8n workers (default 2048)
NODE_OPTIONS=--max-old-space-size=2048
```

---

## Security Notes

1. **All database ports bound to localhost** - postgres (5432), redis (6379) not exposed externally
2. **Docker socket read-only** - terminal-server has read-only access
3. **No new privileges** - ai-server-serve runs with `no-new-privileges:true`
4. **Secrets in .env** - Never commit `.env` file; use CI/CD secrets
