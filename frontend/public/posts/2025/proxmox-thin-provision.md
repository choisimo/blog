---
title: "ZFS 풀 앞에서 멈춰 선 Proxmox, 그 밤의 기록"
date: "2025-10-24"
category: "Linux"
tags: ['Proxmox', 'ZFS', 'Thin Provision', '가상화', '스토리지']
excerpt: "1.85TB 디스크를 추가하려다 ZFS가 '공간 없음'을 외친 밤. 스냅샷과 예약 공간 사이에서 배운 얇은 줄타기 경험담"
readTime: "6분"
---

그날 밤 Proxmox 대시보드는 말끔했지만, 새 VM 디스크를 추가하는 순간 화면이 얼어붙었습니다. `cannot create 'EA_raid_disk/vm-104-disk-0': out of space`라는 메시지가 달랑 떠 있고, VM은 급히 멈춰 섰죠. 여유 공간이 분명히 남아 있었는데도 말입니다. 혹시 여러분도 이런 경험 없으신가요? 저는 그 자리에서 ZFS가 보여주는 숫자와 실제로 예약해 둘 수 있는 공간이 왜 다른지 다시 배우게 됐습니다.

### 그날 새벽, 1.85TB가 막힌 이유

Proxmox에서 ZFS zvol을 기본값 그대로 만들면 두 손 가득한 **Thick Provisioning**을 택합니다. 1.85TB 디스크를 선언하는 순간 ZFS는 똑같은 크기의 `refreservation`을 확보하려고 덤비죠. "아직 빈 공간인데 왜?" 하고 속으로 외쳤지만, 풀 안쪽에서는 이미 스냅샷과 예약분이 차곡차곡 쌓여 있었습니다. ZFS는 실제 데이터가 아닌 **미래에 쓸 자리**까지 미리 약속해 둔 셈이라, 남은 물리 용량보다 예약을 먼저 따져 보고 "이건 못 빌려주겠다"며 막아 세운 거였습니다.

사실 VM이 툭 떨어진 것도 같은 맥락이었어요. 디스크 추가가 실패한 뒤 설정이 비틀어졌고, ZFS가 I/O를 잠시 막으면서 VM이 파즈(Pause) 상태로 미끄러진 겁니다. 순간적으로 "혹시 풀 자체가 꽉 찼나?" 하는 두려움이 엄습했지만, 실제로는 예약 공간이 딱 막혀 있었습니다. Thick Provisioning이 주는 안전선이 이럴 때는 족쇄가 되기도 하더군요.

### 진단은 이렇게 풀어냈다

첫 번째로 한 일은 냉정하게 숫자를 확인하는 것이었습니다. `zpool list`를 실행해 `FREE` 값이 1.85TB보다 작다는 사실을 확인했죠. 처음엔 "분명 여유 공간이 더 있어야 하는데"라고 생각했지만, 바로 이어서 `zfs list -o space -r EA_raid_disk`를 돌려 보니 진짜 원인이 드러났습니다. `USEDSNAP`에 적힌 용량이 예상보다 훨씬 컸고, 몇몇 zvol에는 `USEDREFRESERV`가 두툼하게 쌓여 있었습니다. 스냅샷과 예약이 눈에 보이지 않는 곳에서 공간을 꽉 움켜쥐고 있었던 거죠.

여기서 중요한 건, 숫자를 확인하는 명령어가 단순한 스크립트가 아니라 **상황을 해석하도록 도와주는 대화**라는 사실입니다. 저는 모니터 앞에서 "그렇다면 먼저 스냅샷을 정리해야겠구나" 하고 중얼거렸고, 바로 Proxmox UI의 Snapshots 탭으로 향했습니다. 오래된 스냅샷을 삭제하고 몇 분을 기다렸더니 ZFS가 한숨을 돌린 듯 예약 공간이 조금씩 풀리기 시작했습니다. 공감 가시죠? 우리는 늘 데이터의 보험과 실사용 사이에서 줄타기를 합니다.

### 선택지는 결국 세 가지였다

스냅샷 정리가 어느 정도 끝나자 다음에 할 일을 차분히 정리할 수 있었습니다. 불필요한 VM과 ISO를 지워 실제 여유 공간을 넓히고, 그래도 부족하면 물리 디스크를 추가하거나 풀 구성을 변경하는 방법이 떠올랐죠. 여기까지가 솔직히 가장 안전한 경로입니다. 다만 새벽에 마주한 프로젝트는 당장 서비스를 띄워야 했기에 저는 Thin Provision 옵션을 잠깐 바라보기도 했습니다. Proxmox 스토리지 설정에서 `Thin provision` 체크박스를 켜면, ZFS가 공간을 실제로 쓸 때까지 예약하지 않고 "나중에 채우자"며 느긋하게 움직입니다.

하지만 Thin Provision은 말 그대로 얇은 얼음판 위를 걷는 기분입니다. 여러 VM이 동시에 디스크를 채우기 시작하면, 어느 순간 실제 풀 용량이 바닥나고 모든 VM이 멈출 수 있거든요. 저는 그 순간 스스로에게 "당장의 편안함을 위해 전체 풀을 위험에 빠뜨릴 건가?"라고 물었습니다. 결국 Thin Provision은 최후의 비상용으로만 바라보고, 스냅샷과 예약을 정리하는 쪽을 선택했습니다. 잠시 머리를 식히고 나니, 지름길 대신 꾸준한 정리가 장기적으로 훨씬 담백하다는 사실이 또 한 번 확인됐습니다.

### 마무리하며: 예약과 현실 사이에서

이번 사건을 겪고 나니 ZFS는 숫자를 정확히 맞추는 꼼꼼한 회계사 같다는 생각이 듭니다. 눈앞에 보이는 "남은 공간"보다 "예약한 공간"을 먼저 떠올리는 습관을 들여야 한다는 말이죠. 다시는 같은 실수를 반복하지 않기 위해 저는 주기적으로 `zfs list -o space`를 확인하고, 스냅샷을 장기간 방치하지 않기로 마음먹었습니다. 여러분도 혹시 Proxmox에서 갑자기 디스크가 안 만들어지고 VM이 멈춰 버린다면, 겁먹기 전에 ZFS가 어떤 약속을 지키려 하고 있는지부터 살펴보세요. 그리고 Thin Provision이라는 유혹 앞에서는 한 번 더 숨을 고르시길 바랍니다. 정말 간단하진 않지만, 이렇게 정리해 두면 다음 밤엔 훨씬 덜 당황하게 되더라고요.