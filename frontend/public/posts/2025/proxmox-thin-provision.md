안녕하세요\! Proxmox에서 ZFS 스토리지 사용 시 자주 발생하는 문제입니다. 화면에 보이는 여유 공간과 ZFS가 실제로 새 디스크를 할당할 수 있는 공간 사이에 차이가 있기 때문에 발생하는 현상입니다.

**결론부터 말씀드리면, ZFS 풀(Pool)에 새 가상 디스크(1.85TB)를 위한 공간 예약(`refreservation`)이 불가능할 만큼의 여유 공간만 남아있기 때문입니다.**

VM이 꺼지는 현상은 디스크 추가/변경 작업이 실패하면서 해당 VM의 설정이 꼬이거나, I/O 오류가 발생하며 VM이 일시적으로 정지(pause) 상태에 빠지기 때문일 수 있습니다.

-----

## \#\#\# 원인 상세 분석

Proxmox에서 ZFS 스토리지에 'raw' 포맷의 디스크(zvol)를 생성하면, 기본적으로 **Thick Provisioning** 방식으로 동작합니다. 즉, 1.85TB 디스크를 만든다고 하면 실제로 ZFS 풀에서 1.85TB의 공간을 미리 예약(reserve)하려고 시도합니다. 이는 나중에 디스크에 데이터를 채울 때 공간 부족으로 VM이 멈추는 심각한 상황을 방지하기 위한 안정적인 방식입니다.

오류 메시지 `cannot create 'EA_raid_disk/vm-104-disk-0': out of space`는 바로 이 **예약 과정에서 실패**했다는 의미입니다. ZFS 풀의 전체 남은 용량이 1.85TB보다 크더라도, 다른 VM들의 스냅샷(snapshot)이나 기타 데이터들이 공간을 차지하고 있어 **새로운 예약을 할당할 수 없는 상태**일 가능성이 매우 높습니다.

주요 원인은 다음과 같습니다.

1.  **ZFS 스냅샷(Snapshot)이 차지하는 공간**: 가장 흔한 원인입니다. VM을 백업하거나 특정 시점을 저장하면 스냅샷이 생성됩니다. 이 스냅샷들은 보이지 않게 디스크 공간을 계속 차지하고 있습니다.
2.  **실제 여유 공간 부족**: ZFS 풀의 전체 용량(`zpool list`의 `FREE`)이 실제로 1.85TB 미만일 수 있습니다.
3.  **예약(Reservation) 및 할당량(Quota)**: 다른 VM 디스크나 데이터셋에 공간이 예약되어 있어 가용 공간이 부족할 수 있습니다.

-----

## \#\#\# 해결을 위한 진단 및 조치 방법

PVE 노드의 쉘(Shell)이나 SSH로 접속해서 아래 명령어들을 실행해 보세요.

#### **1. ZFS 풀의 전체 상태 확인**

먼저 `EA_raid_disk` 풀의 실제 할당량과 여유 공간을 확인합니다.

```bash
zpool list EA_raid_disk
```

위 명령어를 실행했을 때 `FREE` 항목에 표시되는 용량이 생성하려는 디스크 크기(1.85TB)보다 작은지 확인해 보세요.

#### **2. 데이터셋 및 스냅샷이 사용하는 공간 확인**

어떤 항목(VM 디스크, 스냅샷 등)이 공간을 많이 차지하는지 상세하게 확인합니다.

```bash
zfs list -o space -r EA_raid_disk
```

이 명령어는 각 데이터셋별로 사용량, 스냅샷 사용량(`USEDSNAP`), 예약된 공간(`USEDREFRESERV`) 등을 자세히 보여줍니다. `USEDSNAP` 항목에 용량이 크게 잡혀있다면 스냅샷이 원인일 가능성이 큽니다.

-----

## \#\#\# 해결 방안

진단 결과에 따라 아래 방법들을 시도해 볼 수 있습니다.

#### **가장 먼저 시도할 것: 불필요한 스냅샷 삭제**

오래되거나 더 이상 필요 없는 VM의 스냅샷을 삭제하여 공간을 확보하는 것이 가장 효과적입니다.

1.  Proxmox UI에서 공간을 많이 차지할 것으로 의심되는 VM을 선택합니다.
2.  **'Snapshots'** 탭으로 이동하여 불필요한 스냅샷을 선택하고 **'Remove'** 버튼으로 삭제합니다.
3.  삭제 후 공간이 바로 확보되지 않을 수 있으니, 잠시 기다린 후 다시 디스크 추가를 시도해 보세요.

#### **그 외 해결 방법**

  * **불필요한 VM, CT, ISO 이미지 삭제**: `EA_raid_disk` 스토리지에 저장된 다른 가상머신이나 컨테이너, ISO 파일을 삭제하여 공간을 확보합니다.
  * **물리 디스크 추가**: 근본적인 해결책으로, ZFS 풀에 새로운 물리 디스크를 추가하여 전체 저장 공간을 늘릴 수 있습니다.
  * **(주의\!) Thin Provisioning 사용**: 디스크 공간을 미리 예약하지 않고, 실제 데이터가 써질 때마다 할당하는 '씬 프로비저닝' 방식으로 디스크를 생성할 수 있습니다.
      * **방법**: **데이터센터 -\> 스토리지 -\> EA\_raid\_disk 선택 후 'Edit' -\> 'Thin provision' 체크**
      * ⚠️ **경고**: 이 방법은 당장의 오류는 해결해주지만, 나중에 여러 VM이 동시에 디스크를 사용하다가 ZFS 풀의 실제 공간이 꽉 차면 **해당 풀을 사용하는 모든 VM이 멈추거나 데이터가 손상될 수 있는 위험**이 있습니다. 추천하는 방법은 아닙니다.