# AGENTS.md — workers/

## OVERVIEW

Four Cloudflare Workers forming the edge layer. TypeScript, built with `wrangler`. All workers use `nodejs_compat` flag.

## WORKERS

| Worker | Domain | Purpose |
|--------|--------|---------|
| `api-gateway` | `api.nodove.com` | Unified API — D1/R2/KV + proxy to backend |
| `r2-gateway` | (internal) | R2 object storage proxy |
| `terminal-gateway` | `terminal.nodove.com` | WebSocket proxy to backend terminal-server |
| `seo-gateway` | `noblog.nodove.com` | SSR meta-tag injection for crawlers |

## STRUCTURE

```
workers/
├── api-gateway/
│   └── src/
│       ├── index.ts        # Hono app entry — registers all routes
│       ├── types.ts        # HonoEnv, Env bindings
│       ├── routes/         # 22 route files (one per domain)
│       ├── lib/            # Shared utilities (d1, r2, jwt, cors, ai, etc.)
│       ├── middleware/     # cors, logger, tracing, error
│       └── config/         # Worker configuration
├── r2-gateway/src/index.ts
├── terminal-gateway/src/   # index.ts, auth.ts, ratelimit.ts
├── seo-gateway/src/        # index.ts, meta-rewriter.ts, crawler-detect.ts
├── migrations/             # D1 SQL migration files
├── scripts/                # Worker utility scripts
├── tsconfig.json           # Shared TypeScript config
└── package.json            # Shared scripts (dev, deploy, migrations)
```

## WHERE TO LOOK

| Task | Location |
|------|----------|
| Add API route | `api-gateway/src/routes/<domain>.ts` + register in `api-gateway/src/index.ts` |
| Add shared util | `api-gateway/src/lib/<util>.ts` |
| Add D1 migration | `migrations/` (create with `npm run migrations:create`) |
| Wrangler bindings (D1/R2/KV) | Each worker's `wrangler.toml` |
| Worker secrets | `wrangler secret put <NAME> --env production` |
| R2 file serving | `r2-gateway/src/index.ts` |
| Terminal proxy | `terminal-gateway/src/index.ts` |
| SEO meta injection | `seo-gateway/src/meta-rewriter.ts` |

## API-GATEWAY ROUTES

Key routes in `api-gateway/src/routes/`:

`auth`, `posts`, `comments`, `ai`, `chat`, `images`, `og`, `analytics`, `translate`, `config`, `rag`, `gateway`, `memos`, `memories`, `admin-ai`, `secrets`, `personas`, `user-content`, `search`, `user`, `debate`, `subscribe`

`gateway.ts` — proxy forwarding to `BACKEND_ORIGIN` for routes not handled natively.

## CONVENTIONS

- **Framework**: Hono (not Express) — use `app.route('/path', router)` pattern
- **Type bindings**: `HonoEnv` in `types.ts` — all `env.*` access must be typed there
- **Secrets**: never in `wrangler.toml` vars — always `wrangler secret put`
- **CORS**: centralized in `lib/cors.ts` and `middleware/cors.ts`
- **D1 access**: via `lib/d1.ts` helpers — never raw `env.DB.prepare()` in routes
- **Env config**: `[vars]` in `wrangler.toml` for non-secrets; `[env.production]` block for prod overrides

## ANTI-PATTERNS

- Do NOT hardcode secrets in `wrangler.toml`
- Do NOT add new bindings without updating `types.ts` (HonoEnv)
- Do NOT use `express`/`fastify` — Hono only
- Do NOT edit auto-generated D1 migration files after applying to production

## COMMANDS

```bash
# Run from workers/
npm run dev                     # wrangler dev (api-gateway default)
npm run deploy                  # staging deploy
npm run deploy:prod             # production deploy
npm run migrations:apply:prod   # apply D1 migrations to production
npm run migrations:create       # create new migration file
npm run typecheck               # tsc --noEmit
npm run format                  # prettier

# Per-worker dev (run from workers/<name>/)
wrangler dev
wrangler deploy --env production
wrangler secret put <NAME> --env production
```

## NOTES

- `workers/package.json` has no `workspaces` — each worker has its own `node_modules` via its own `wrangler.toml`
- `api-gateway` is the primary worker; other workers are standalone
- `seo-gateway` sits in front of GitHub Pages and rewrites `<meta>` tags for crawlers
- D1 database: `blog-db` (local), `blog-db-prod` (production)
- `worker-configuration.d.ts` at root is auto-generated by wrangler
