# =============================================================================
# Nginx Configuration - Local Development Gateway
# =============================================================================
#
# Routes (Production과 동일한 구조):
#   /                 → frontend (React SPA)
#   /api/*            → backend (Blog API)
#   /ai/*             → litellm (LiteLLM Gateway - OpenAI compatible)
#   /workers/*        → workers (Cloudflare Workers emulation)
#   /terminal/*       → terminal-server (WebSocket PTY)
#
# =============================================================================

upstream frontend_upstream {
    server frontend:80;
    keepalive 32;
}

upstream backend_upstream {
    server backend:5080;
    keepalive 32;
}

upstream litellm_upstream {
    server litellm:4000;
    keepalive 16;
}

upstream workers_upstream {
    server workers:8787;
    keepalive 16;
}

upstream terminal_upstream {
    server terminal-server:8080;
    keepalive 8;
}

server {
    listen 80;
    server_name localhost _;

    client_max_body_size 50m;

    # Timeouts for long-running AI requests
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Common proxy headers
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # -------------------------------------------------------------------------
    # Health Check
    # -------------------------------------------------------------------------
    location = /health {
        add_header Content-Type application/json;
        return 200 '{"status":"ok","service":"nginx-local-gateway"}';
    }

    # -------------------------------------------------------------------------
    # Backend API (/api/*)
    # -------------------------------------------------------------------------
    location /api/ {
        proxy_pass http://backend_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
        
        # SSE support for streaming AI responses
        proxy_cache off;
        chunked_transfer_encoding on;
    }

    # -------------------------------------------------------------------------
    # LiteLLM Gateway - OpenAI Compatible AI API (/ai/*)
    # -------------------------------------------------------------------------
    # All AI requests go through LiteLLM which handles:
    # - Provider routing (OpenAI, Gemini, Claude, etc.)
    # - Automatic fallback on failures
    # - Rate limiting and load balancing
    #
    # Examples:
    #   POST /ai/v1/chat/completions → LiteLLM → Any Provider
    #   GET  /ai/v1/models           → List available models
    #   GET  /ai/health              → LiteLLM health check
    location /ai/ {
        rewrite ^/ai/(.*)$ /$1 break;
        proxy_pass http://litellm_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
        
        # SSE support for streaming responses
        proxy_cache off;
        chunked_transfer_encoding on;
        
        # Longer timeout for AI requests
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # -------------------------------------------------------------------------
    # Cloudflare Workers Emulation (/workers/*)
    # -------------------------------------------------------------------------
    # Routes to local wrangler dev server
    # Handles: D1 database, comments, analytics, search, etc.
    location /workers/ {
        rewrite ^/workers/(.*)$ /$1 break;
        proxy_pass http://workers_upstream;
        proxy_set_header Connection "";
        proxy_buffering off;
    }

    # -------------------------------------------------------------------------
    # Terminal WebSocket (/terminal/*)
    # -------------------------------------------------------------------------
    location /terminal/ {
        rewrite ^/terminal/(.*)$ /$1 break;
        proxy_pass http://terminal_upstream;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # -------------------------------------------------------------------------
    # Frontend (React SPA) - Catch-all
    # -------------------------------------------------------------------------
    location / {
        proxy_pass http://frontend_upstream;
        proxy_set_header Connection "";
        
        # Handle SPA routing - let frontend handle 404s
        proxy_intercept_errors off;
    }
}
