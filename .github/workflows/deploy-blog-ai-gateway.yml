name: Deploy Blog AI Gateway

# =============================================================================
# Cloudflare Workers Deployment - Blog AI Gateway
# =============================================================================
# Deploys the blog-ai-gateway worker for AI service routing with:
# - Multiple AI agent server support (primary + fallback)
# - R2 storage via service binding
# - JWT authentication
# - Retry and timeout configuration
#
# Routes:
#   - blog-ai.nodove.com/* (new)
#   - ai-check.nodove.com/* (legacy, backward compatible)
# =============================================================================

on:
  push:
    branches: [ main ]
    paths:
      - 'workers/blog-ai-gateway/**'
      - '.github/workflows/deploy-blog-ai-gateway.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Blog AI Gateway
    permissions:
      contents: read
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: workers/blog-ai-gateway
        run: npm ci

      - name: Set Secrets (production)
        working-directory: workers/blog-ai-gateway
        run: |
          if [ -n "${{ secrets.SECRET_INTERNAL_KEY }}" ]; then
            echo "${{ secrets.SECRET_INTERNAL_KEY }}" | npx wrangler secret put SECRET_INTERNAL_KEY --env production
          fi
          if [ -n "${{ secrets.SECRET_CALLER_KEY }}" ]; then
            echo "${{ secrets.SECRET_CALLER_KEY }}" | npx wrangler secret put SECRET_CALLER_KEY --env production
          fi
          if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "${{ secrets.GH_PAT_TOKEN }}" | npx wrangler secret put GITHUB_TOKEN --env production
          fi

      - name: Deploy blog-ai-gateway (production)
        working-directory: workers/blog-ai-gateway
        run: npx wrangler deploy --env ${{ github.event.inputs.environment || 'production' }}

      - name: Deployment summary
        run: |
          echo "‚úÖ blog-ai-gateway deployed successfully"
          echo "üåç Routes:"
          echo "   - blog-ai.nodove.com/*"
          echo "   - ai-check.nodove.com/* (legacy)"
          echo "üìã AI Agent servers configured in wrangler.toml"
