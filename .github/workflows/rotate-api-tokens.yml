name: Rotate API Tokens

# =============================================================================
# API Token Rotation Workflow
# =============================================================================
# JWT 토큰을 주기적으로 또는 수동으로 로테이션하여 보안 강화
#
# 동작:
#   1. Blog API에서 새 JWT 토큰 생성
#   2. (optional) Apply to other gateways if needed
#
# 사용법:
#   - 수동 실행: Actions > Rotate API Tokens > Run workflow
#   - 자동 실행: 매주 일요일 03:00 UTC (한국시간 12:00)
# =============================================================================

on:
  # 수동 트리거
  workflow_dispatch:
    inputs:
      force_rotation:
        description: 'Force token rotation even if recent'
        required: false
        default: false
        type: boolean

  # 정기 실행 (매주 일요일 03:00 UTC)
  schedule:
    - cron: '0 3 * * 0'

permissions:
  contents: read

concurrency:
  group: rotate-api-tokens
  cancel-in-progress: false

env:
  DEPLOY_DIR: blog-stack

jobs:
  rotate-tokens:
    name: Rotate API Tokens
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || '22' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ env.SSH_PORT }}" -H "${{ env.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Check service availability
        id: health_check
        run: |
          ssh -p "${{ env.SSH_PORT }}" "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" << 'HEALTH_SCRIPT'
          set -euo pipefail
          
          echo "=== Service Health Check ==="
          
          # Check Blog API
          if curl -sf "http://localhost:5080/api/v1/healthz" > /dev/null 2>&1; then
            echo "Blog API: OK"
          else
            echo "Blog API: UNAVAILABLE"
            exit 1
          fi
          
          echo ""
          HEALTH_SCRIPT

      - name: Generate new API token
        id: generate_token
        run: |
          TOKEN=$(ssh -p "${{ env.SSH_PORT }}" "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" << 'TOKEN_SCRIPT'
          set -euo pipefail
          
          echo "=== Generating New JWT Token ===" >&2
          
          # Login to Blog API
          RESPONSE=$(curl -sf "http://localhost:5080/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "${{ vars.ADMIN_USERNAME || 'admin' }}",
              "password": "${{ secrets.ADMIN_PASSWORD }}"
            }' 2>/dev/null)
          
          TOKEN=$(echo "$RESPONSE" | jq -r '.data.token // .token // empty')
          
          if [ -z "$TOKEN" ]; then
            echo "ERROR: Failed to generate token" >&2
            exit 1
          fi
          
          # Output token (will be captured)
          echo "$TOKEN"
          TOKEN_SCRIPT
          )
          
          if [ -z "$TOKEN" ]; then
            echo "::error::Failed to generate API token"
            exit 1
          fi
          
          echo "token=${TOKEN}" >> $GITHUB_OUTPUT
          echo "Token generated successfully: ${TOKEN:0:20}..."

      - name: Log rotation event
        run: |
          ssh -p "${{ env.SSH_PORT }}" "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" << 'LOG_SCRIPT'
          set -euo pipefail
          
          LOG_FILE=~/blog-stack/logs/token-rotation.log
          mkdir -p ~/blog-stack/logs
          
          echo "[$(date -Iseconds)] Token rotated successfully" >> "$LOG_FILE"
          echo "  - Trigger: ${{ github.event_name }}" >> "$LOG_FILE"
          echo "  - Actor: ${{ github.actor }}" >> "$LOG_FILE"
          echo "  - Gateways: skipped" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          
          # Keep only last 100 entries
          tail -n 500 "$LOG_FILE" > "${LOG_FILE}.tmp" && mv "${LOG_FILE}.tmp" "$LOG_FILE"
          LOG_SCRIPT

      - name: Summary
        run: |
          echo "## Token Rotation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Gateway Updates**: Skipped" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -Iseconds)" >> $GITHUB_STEP_SUMMARY
