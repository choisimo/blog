name: Sync Backend Environment Variables

on:
  workflow_dispatch:
    inputs:
      restart_services:
        description: 'Restart Docker services after env update'
        required: false
        default: false
        type: boolean
      services_to_restart:
        description: 'Services to restart (comma-separated, e.g., "api" or "all")'
        required: false
        default: 'none'
        type: string

permissions:
  contents: read

concurrency:
  group: backend-env-sync
  cancel-in-progress: false

env:
  DEPLOY_DIR: blog-stack

jobs:
  sync-env:
    name: Sync Environment Variables
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || '22' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          for i in 1 2 3; do
            if ssh-keyscan -p "${{ env.SSH_PORT }}" -H "${{ env.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null; then
              break
            fi
            sleep 5
          done
          chmod 600 ~/.ssh/known_hosts

      - name: Generate .env file from secrets
        run: |
          cat > /tmp/blog-stack.env << 'ENVEOF'
          # Blog Stack Environment Variables
          # Generated by GitHub Actions: ${{ github.run_id }}
          # Timestamp: $(date -u '+%Y-%m-%dT%H:%M:%SZ')
          # NOTE: Backend code is managed manually by server admin via git clone

          # Application
          APP_ENV=${{ secrets.APP_ENV || 'production' }}
          GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}

          # URLs
          SITE_BASE_URL=${{ secrets.SITE_BASE_URL || 'https://noblog.nodove.com' }}
          API_BASE_URL=${{ secrets.API_BASE_URL || 'https://blog-b.nodove.com' }}
          ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS || 'https://noblog.nodove.com,https://blog.nodove.com' }}
          ASSETS_BASE_URL=${{ secrets.ASSETS_BASE_URL || '' }}

          # PostgreSQL
          POSTGRES_DB=${{ secrets.POSTGRES_DB || 'blog' }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER || 'bloguser' }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

          # Redis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

          # MongoDB
          MONGO_USER=${{ secrets.MONGO_USER || 'mongouser' }}
          MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
          MONGO_DB=${{ secrets.MONGO_DB || 'blog' }}

          # Qdrant
          QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}

          # AI Configuration
          AI_DEFAULT_MODEL=${{ secrets.AI_DEFAULT_MODEL || 'gpt-4.1' }}
          AI_SERVER_URL=${{ secrets.AI_SERVER_URL || 'https://api.openai.com/v1' }}
          AI_API_KEY=${{ secrets.AI_API_KEY || secrets.OPENAI_API_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY || secrets.AI_API_KEY }}
          AI_EMBEDDING_URL=${{ secrets.AI_EMBEDDING_URL || secrets.AI_SERVER_URL || 'https://api.openai.com/v1' }}
          AI_EMBEDDING_API_KEY=${{ secrets.AI_EMBEDDING_API_KEY || secrets.AI_API_KEY || secrets.OPENAI_API_KEY }}
          AI_EMBED_MODEL=${{ secrets.AI_EMBED_MODEL || 'text-embedding-3-small' }}
          GOOGLE_API_KEY=${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          VAS_API_KEY=

          # AI Admin
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL || 'admin@nodove.com' }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}

          # GitHub
          GITHUB_TOKEN=${{ secrets.GH_PAT_TOKEN }}
          GITHUB_REPO_OWNER=${{ secrets.GITHUB_REPO_OWNER || 'choisimo' }}
          GITHUB_REPO_NAME=${{ secrets.GITHUB_REPO_NAME || 'blog' }}

          # Admin Auth
          ADMIN_BEARER_TOKEN=${{ secrets.ADMIN_BEARER_TOKEN }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME || 'admin' }}

          # Terminal Server (Backend Authentication)
          BACKEND_KEY=${{ secrets.BACKEND_KEY }}
          SANDBOX_IMAGE=${{ secrets.SANDBOX_IMAGE || format('ghcr.io/{0}/blog-terminal-sandbox:latest', github.repository_owner) }}

          # MinIO
          MINIO_USER=${{ secrets.MINIO_USER || 'minioadmin' }}
          MINIO_PASSWORD=${{ secrets.MINIO_PASSWORD }}

          # Firecrawl
          FIRECRAWL_API_TOKEN=${{ secrets.FIRECRAWL_API_TOKEN }}

          # Monitoring
          GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD }}
          PGADMIN_EMAIL=${{ secrets.PGADMIN_EMAIL || 'admin@nodove.com' }}
          PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
          ENVEOF

      - name: Upload .env to server
        run: |
          ssh -p "${{ env.SSH_PORT }}" "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" \
            "mkdir -p ~/${{ env.DEPLOY_DIR }}"

          scp -P "${{ env.SSH_PORT }}" /tmp/blog-stack.env \
            "${{ env.SSH_USER }}@${{ env.SSH_HOST }}:~/${{ env.DEPLOY_DIR }}/.env"

          echo "Environment file uploaded to ~/${{ env.DEPLOY_DIR }}/.env"

      - name: Setup SSL certificates
        run: |
          ssh -p "${{ env.SSH_PORT }}" "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" << 'SSL_SCRIPT'
          DEPLOY_DIR="$HOME/${{ env.DEPLOY_DIR }}"
          mkdir -p "$DEPLOY_DIR/ssl"

          if [ -n "${{ secrets.SSL_CERT }}" ] && [ -n "${{ secrets.SSL_KEY }}" ]; then
            echo "Updating SSL certificates from secrets..."

            cat > "$DEPLOY_DIR/ssl/origin.crt" << 'CERT_EOF'
          ${{ secrets.SSL_CERT }}
          CERT_EOF

            cat > "$DEPLOY_DIR/ssl/origin.key" << 'KEY_EOF'
          ${{ secrets.SSL_KEY }}
          KEY_EOF

            chmod 644 "$DEPLOY_DIR/ssl/origin.crt"
            chmod 600 "$DEPLOY_DIR/ssl/origin.key"
            echo "SSL certificates updated"
          else
            echo "No SSL secrets provided, keeping existing certificates"
          fi
          SSL_SCRIPT

      - name: Restart services (optional)
        if: ${{ github.event.inputs.restart_services == 'true' && github.event.inputs.services_to_restart != 'none' }}
        run: |
          ssh -p "${{ env.SSH_PORT }}" "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" << 'RESTART_SCRIPT'
          set -euo pipefail
          cd "$HOME/${{ env.DEPLOY_DIR }}"

          DC="docker compose"
          if ! $DC version >/dev/null 2>&1; then DC="docker-compose"; fi

          SERVICES="${{ github.event.inputs.services_to_restart }}"

          if [ "$SERVICES" = "all" ]; then
            echo "Restarting all services..."
            $DC restart
          else
            echo "Restarting services: $SERVICES"
            IFS=',' read -ra SVC_ARRAY <<< "$SERVICES"
            for svc in "${SVC_ARRAY[@]}"; do
              svc=$(echo "$svc" | xargs)
              if [ -n "$svc" ]; then
                echo "Restarting $svc..."
                $DC restart "$svc" || echo "Warning: Failed to restart $svc"
              fi
            done
          fi

          echo ""
          echo "Service status:"
          $DC ps
          RESTART_SCRIPT

      - name: Verify environment
        run: |
          ssh -p "${{ env.SSH_PORT }}" "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" << 'VERIFY_SCRIPT'
          DEPLOY_DIR="$HOME/${{ env.DEPLOY_DIR }}"

          echo "=== Environment File Status ==="
          if [ -f "$DEPLOY_DIR/.env" ]; then
            echo "âœ… .env file exists"
            echo "   Size: $(wc -c < "$DEPLOY_DIR/.env") bytes"
            echo "   Lines: $(wc -l < "$DEPLOY_DIR/.env")"
            echo "   Last modified: $(stat -c %y "$DEPLOY_DIR/.env" 2>/dev/null || stat -f %Sm "$DEPLOY_DIR/.env" 2>/dev/null)"
          else
            echo "âŒ .env file not found"
          fi

          echo ""
          echo "=== SSL Certificate Status ==="
          if [ -f "$DEPLOY_DIR/ssl/origin.crt" ]; then
            echo "âœ… SSL certificate exists"
            openssl x509 -in "$DEPLOY_DIR/ssl/origin.crt" -noout -dates 2>/dev/null || echo "   (Could not parse certificate)"
          else
            echo "âš ï¸  SSL certificate not found"
          fi

          echo ""
          echo "=== Docker Service Status ==="
          cd "$DEPLOY_DIR" 2>/dev/null && docker compose ps 2>/dev/null || echo "No running services or docker-compose.yml not found"
          VERIFY_SCRIPT

      - name: Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ENVIRONMENT SYNC COMPLETE                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Environment variables synced to server"
          echo "ğŸ“ Location: ~/${{ env.DEPLOY_DIR }}/.env"
          echo ""
          echo "To apply changes manually, SSH to the server and run:"
          echo "  cd ~/${{ env.DEPLOY_DIR }}"
          echo "  docker compose up -d"
          echo ""
          echo "Or use the restart option in this workflow."
