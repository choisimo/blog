#!/bin/bash
set -e

CONSUL_ADDR="${CONSUL_HTTP_ADDR:-http://localhost:8500}"
PREFIX="blog"

print_usage() {
  echo "Blog Configuration Manager (Consul KV)"
  echo ""
  echo "Usage: blog-config <command> [args]"
  echo ""
  echo "Commands:"
  echo "  list                     List all configuration keys"
  echo "  get <key>                Get a configuration value"
  echo "  set <key> <value>        Set a configuration value"
  echo "  delete <key>             Delete a configuration key"
  echo "  service <name>           Get service URL"
  echo "  services                 List all registered services"
  echo "  health [service]         Check service health"
  echo "  export [file]            Export all KV to JSON"
  echo "  import <file>            Import KV from JSON"
  echo "  watch <key>              Watch a key for changes"
  echo ""
  echo "Examples:"
  echo "  blog-config list"
  echo "  blog-config get config/domains/api"
  echo "  blog-config set config/features/ai_enabled false"
  echo "  blog-config service ai-gateway"
  echo "  blog-config health backend"
  echo ""
}

check_consul() {
  if ! curl -s "${CONSUL_ADDR}/v1/status/leader" | grep -q .; then
    echo "‚ùå Cannot connect to Consul at ${CONSUL_ADDR}"
    exit 1
  fi
}

cmd_list() {
  check_consul
  echo "üìã Configuration Keys (${PREFIX}/):"
  echo ""
  curl -s "${CONSUL_ADDR}/v1/kv/${PREFIX}/?keys" | jq -r '.[]' | sed "s|${PREFIX}/||" | sort
}

cmd_get() {
  check_consul
  local key="$1"
  if [ -z "$key" ]; then
    echo "Usage: blog-config get <key>"
    exit 1
  fi
  
  local result=$(curl -s "${CONSUL_ADDR}/v1/kv/${PREFIX}/${key}")
  if [ "$result" = "null" ] || [ -z "$result" ]; then
    echo "‚ùå Key not found: ${key}"
    exit 1
  fi
  
  echo "$result" | jq -r '.[0].Value' | base64 -d
  echo ""
}

cmd_set() {
  check_consul
  local key="$1"
  local value="$2"
  if [ -z "$key" ] || [ -z "$value" ]; then
    echo "Usage: blog-config set <key> <value>"
    exit 1
  fi
  
  if curl -s -X PUT -d "${value}" "${CONSUL_ADDR}/v1/kv/${PREFIX}/${key}" | grep -q "true"; then
    echo "‚úÖ Set ${PREFIX}/${key}"
  else
    echo "‚ùå Failed to set ${key}"
    exit 1
  fi
}

cmd_delete() {
  check_consul
  local key="$1"
  if [ -z "$key" ]; then
    echo "Usage: blog-config delete <key>"
    exit 1
  fi
  
  if curl -s -X DELETE "${CONSUL_ADDR}/v1/kv/${PREFIX}/${key}" | grep -q "true"; then
    echo "‚úÖ Deleted ${PREFIX}/${key}"
  else
    echo "‚ùå Failed to delete ${key}"
    exit 1
  fi
}

cmd_service() {
  check_consul
  local name="$1"
  if [ -z "$name" ]; then
    echo "Usage: blog-config service <name>"
    exit 1
  fi
  
  local url=$(curl -s "${CONSUL_ADDR}/v1/kv/${PREFIX}/services/${name}/url" | jq -r '.[0].Value // empty' | base64 -d 2>/dev/null)
  
  if [ -n "$url" ]; then
    echo "$url"
  else
    echo "‚ùå Service not found: ${name}"
    exit 1
  fi
}

cmd_services() {
  check_consul
  echo "üîß Registered Services:"
  echo ""
  curl -s "${CONSUL_ADDR}/v1/catalog/services" | jq -r 'keys[]' | while read svc; do
    local health=$(curl -s "${CONSUL_ADDR}/v1/health/service/${svc}?passing=true" | jq 'length')
    echo "  ${svc}: ${health} healthy instance(s)"
  done
}

cmd_health() {
  check_consul
  local service="$1"
  
  if [ -z "$service" ]; then
    echo "üè• All Services Health:"
    echo ""
    curl -s "${CONSUL_ADDR}/v1/health/state/any" | jq -r '.[] | "\(.ServiceName // "node"): \(.Status) - \(.CheckID)"'
  else
    echo "üè• Health for ${service}:"
    echo ""
    curl -s "${CONSUL_ADDR}/v1/health/service/${service}" | jq '.[] | {
      id: .Service.ID,
      address: .Service.Address,
      port: .Service.Port,
      status: .Checks[].Status,
      output: .Checks[].Output
    }'
  fi
}

cmd_export() {
  check_consul
  local file="${1:-consul-export-$(date +%Y%m%d-%H%M%S).json}"
  
  curl -s "${CONSUL_ADDR}/v1/kv/${PREFIX}/?recurse" | jq '[.[] | {key: .Key, value: (.Value | @base64d)}]' > "$file"
  echo "‚úÖ Exported to ${file}"
}

cmd_import() {
  check_consul
  local file="$1"
  if [ -z "$file" ] || [ ! -f "$file" ]; then
    echo "Usage: blog-config import <file>"
    exit 1
  fi
  
  jq -c '.[]' "$file" | while read item; do
    local key=$(echo "$item" | jq -r '.key')
    local value=$(echo "$item" | jq -r '.value')
    curl -s -X PUT -d "${value}" "${CONSUL_ADDR}/v1/kv/${key}" > /dev/null
    echo "‚úì ${key}"
  done
  echo "‚úÖ Import complete"
}

cmd_watch() {
  check_consul
  local key="$1"
  if [ -z "$key" ]; then
    echo "Usage: blog-config watch <key>"
    exit 1
  fi
  
  echo "üëÄ Watching ${PREFIX}/${key} (Ctrl+C to stop)..."
  local index=0
  while true; do
    local result=$(curl -s -H "X-Consul-Index: ${index}" "${CONSUL_ADDR}/v1/kv/${PREFIX}/${key}?index=${index}")
    local new_index=$(curl -sI -H "X-Consul-Index: ${index}" "${CONSUL_ADDR}/v1/kv/${PREFIX}/${key}?index=${index}" | grep -i "X-Consul-Index" | awk '{print $2}' | tr -d '\r')
    
    if [ "$new_index" != "$index" ]; then
      echo "[$(date +%H:%M:%S)] Changed:"
      echo "$result" | jq -r '.[0].Value' | base64 -d
      echo ""
      index=$new_index
    fi
  done
}

case "$1" in
  list)     cmd_list ;;
  get)      cmd_get "$2" ;;
  set)      cmd_set "$2" "$3" ;;
  delete)   cmd_delete "$2" ;;
  service)  cmd_service "$2" ;;
  services) cmd_services ;;
  health)   cmd_health "$2" ;;
  export)   cmd_export "$2" ;;
  import)   cmd_import "$2" ;;
  watch)    cmd_watch "$2" ;;
  *)        print_usage ;;
esac
